<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>KCMF ê°•ì˜í‰ê°€ ì„¤ë¬¸ê´€ë¦¬</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Arial", sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1000px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(45deg, #4f46e5, #7c3aed);
        color: white;
        padding: 30px;
        text-align: center;
        position: relative;
      }
      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        font-weight: bold;
      }
      .header p {
        font-size: 1.1rem;
        opacity: 0.9;
      }

      .nav-tabs {
        display: flex;
        background: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
      }
      .nav-tab {
        flex: 1;
        padding: 15px 20px;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1rem;
        transition: all 0.3s ease;
        color: #64748b;
      }
      .nav-tab.active {
        background: white;
        color: #4f46e5;
        border-bottom: 3px solid #4f46e5;
        font-weight: bold;
      }
      .nav-tab:hover {
        background: #e2e8f0;
      }

      .content {
        padding: 30px;
        min-height: 400px;
      }

      .page {
        display: none;
      }

      .page.active {
        display: block;
        animation: fadeIn 0.5s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .form-group {
        margin-bottom: 20px;
      }
      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        color: #374151;
      }
      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s ease;
      }
      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #4f46e5;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
      }

      .btn {
        background: linear-gradient(45deg, #4f46e5, #7c3aed);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-right: 10px;
        margin-bottom: 10px;
      }
      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(79, 70, 229, 0.3);
      }
      .btn-secondary {
        background: #6b7280;
      }
      .btn-danger {
        background: #dc2626;
      }

      .table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      .table th,
      .table td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid #e5e7eb;
      }
      .table th {
        background: #f8fafc;
        font-weight: bold;
        color: #374151;
      }
      .table tr:hover {
        background: #f8fafc;
      }

      .config-section {
        background: #f8fafc;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
      }
      .config-section h3 {
        color: #4f46e5;
        margin-bottom: 15px;
      }
      .config-section input,
      .config-section select,
      .config-section textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s ease;
      }

      .alert {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
      }
      .alert-success {
        background: #d1fae5;
        color: #065f46;
      }
      .alert-error {
        background: #fee2e2;
        color: #991b1b;
      }
      .alert-info {
        background: #dbeafe;
        color: #1e40af;
      }

      .loading {
        display: none;
        text-align: center;
        padding: 20px;
      }

      .spinner {
        border: 4px solid #e5e7eb;
        border-top: 4px solid #4f46e5;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }
      .stat-card {
        background: linear-gradient(45deg, #4f46e5, #7c3aed);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
      }
      .stat-number {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
      }
      .modal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 30px;
        border-radius: 15px;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
      }

      .close {
        float: right;
        font-size: 24px;
        cursor: pointer;
        color: #6b7280;
      }
      .close:hover {
        color: #374151;
      }

      /* ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ ë¦¬ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
      .scrollable-list {
        max-height: 600px;
        overflow-y: auto;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸ¯ KCMF ê°•ì˜í‰ê°€ ê´€ë¦¬</h1>
        <p>ì‹œì²­ìë¯¸ë””ì–´ì¬ë‹¨ ì§ì›ìš© ì‹œìŠ¤í…œ</p>
      </div>

      <div class="nav-tabs">
        <button
          class="nav-tab active"
          data-page="config"
          onclick="showPage('config')"
        >
          ğŸ”§ë¡œê·¸ì¸
        </button>
        <button class="nav-tab" data-page="admin1" onclick="showPage('admin1')">
          ğŸ“‹êµìœ¡ ê´€ë¦¬
        </button>
        <button class="nav-tab" data-page="admin2" onclick="showPage('admin2')">
          ğŸ“Šì„¤ë¬¸ í˜„í™©
        </button>
        <button class="nav-tab" data-page="survey" onclick="showPage('survey')">
          ğŸ“ì‘ë‹µ ë‚´ì—­
        </button>
      </div>

      <div class="content">
        <!-- DB ì„¤ì • í˜ì´ì§€ -->
        <div id="config" class="page active">
          <div class="config-section">
            <h3>ë¡œê·¸ì¸</h3>
            <div id="loginform" class="form-group">
              <input type="email" id="login_email" placeholder="ì´ë©”ì¼" />
              <input
                type="password"
                id="login_password"
                placeholder="ë¹„ë°€ë²ˆí˜¸"
              />
              <button id="login_btn" class="btn" onclick="signIn()">
                ë¡œê·¸ì¸
              </button>
              <button
                id="logout_btn"
                class="btn btn-secondary"
                onclick="signOut()"
              >
                ë¡œê·¸ì•„ì›ƒ
              </button>
            </div>
            <div id="authStatus" class="alert alert-info"></div>
          </div>

          <div class="config-section">
            <h3>ì„¤ëª…</h3>
            <textarea rows="6">
=== ì‚¬ìš©ë°©ë²• (ì§ì›ìš©) ===

1. ì„¤ë¬¸ í˜ì´ì§€ëŠ” ëˆ„êµ¬ë‚˜ ì ‘ê·¼ ê°€ëŠ¥. ë³´ì•ˆ ì—†ìŒ.
   ê´€ë¦¬ í˜ì´ì§€ëŠ” ë¡œê·¸ì¸ ê³„ì •ì´ í•„ìš”í•¨. ê³„ì • ë°œê¸‰ì€ DBì„¤ì¹˜ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜. 

2. êµìœ¡ ê´€ë¦¬ íƒ­:
  - ì„¤ë¬¸ì€ ì„¼í„°ëª…+ê°•ì‚¬ëª…+êµìœ¡ëª… ì¡°í•©ì— ë”°ë¼ ê° êµìœ¡ë³„ë¡œ ì„¤ë¬¸ì´ ìƒì„±ë¨
  - ìˆ˜ê°•ìƒì—ê²Œ ì•ˆë‚´í•  ì„¤ë¬¸ í˜ì´ì§€ ì£¼ì†ŒëŠ” survey.html ë’¤ì— #s=ê³ ìœ í‚¤ ë¥¼ ë¶™ì´ë©´ ë¨. (ê³ ìœ í‚¤ë¥¼ ì‚¬ìš©í•˜ëŠ” ì´ìœ ëŠ” ì•„ë¬´ ë²ˆí˜¸ë‚˜ ì…ë ¥í•´ì„œ ë‹¤ë¥¸ ì‚¬ëŒì˜ ì„¤ë¬¸ì— ì ‘ê·¼í•˜ëŠ” ê²ƒì„ ë§‰ê¸° ìœ„í•´ì„œì„.) 
  - ì„¤ë¬¸ í˜ì´ì§€ì— ê°€ì„œ QRì½”ë“œë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŒ.
  - ì„¤ë¬¸ ê°€ëŠ¥í•œ ê¸°ê°„ì€ ê¸°ë³¸ê°’ìœ¼ë¡œ ìƒì„±ì¼ë¡œë¶€í„° 1ê°œì›”ê°„ì„. ì„¤ë¬¸ê¸°ê°„ ì´ì™¸ì—ëŠ” ì‘ë‹µí•  ìˆ˜ ì—†ìŒ. (ì—­ì‹œ ë³´ì•ˆì„ ìœ„í•´ í•„ìš”í•¨.)
  - ì§ì› ê³„ì •ì€ ìì‹ ì´ ë§Œë“  êµìœ¡ë§Œ ìˆ˜ì •í•˜ê±°ë‚˜ ì‚­ì œí•  ìˆ˜ ìˆìœ¼ë©°, ë‹¤ë¥¸ ì§ì› ê³„ì •ì˜ ë°ì´í„°ë¥¼ ê±´ë“œë¦´ ìˆ˜ ì—†ìŒ. 
  - êµìœ¡ê³¼ì •ì„ ìˆ˜ì •í•˜ë”ë¼ë„ ì´ë¯¸ ì§„í–‰ëœ ì„¤ë¬¸ë‚´ìš©ì€ ë°”ë€Œì§€ ì•ŠìŒ. (ì„¼í„°ëª…, ê°•ì‚¬ëª…, êµìœ¡ëª…ì´ ë‹¬ë¼ë„ ë™ì¼í•œ ê³ ìœ í‚¤ë¥¼ ê°€ì§„ ì„¤ë¬¸ì‘ë‹µì´ ì¡´ì¬í•  ìˆ˜ ìˆìŒ.)

3. ì„¤ë¬¸ í˜„í™© íƒ­:
  - ìˆ˜ê°•ìƒë“¤ì´ ì‘ì„±í•œ ì„¤ë¬¸ì‘ë‹µì˜ ëª©ë¡ê³¼ í†µê³„ë¥¼ ë³¼ ìˆ˜ ìˆìŒ.
  - ê²€ìƒ‰ì„ í•˜ë©´ ê²€ìƒ‰ì¡°ê±´ì— ë”°ë¥¸ ê²°ê³¼ë§Œ ê°€ì§€ê³  í†µê³„ì™€ ëª©ë¡ì„ ë³´ì—¬ì¤Œ.
  - ìƒì„¸ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì‘ë‹µ ë‚´ì—­ íƒ­ìœ¼ë¡œ ì´ë™í•˜ê²Œ ë¨.

4. ì‘ë‹µ ë‚´ì—­ íƒ­:
  - ì„¤ë¬¸ í˜„í™© íƒ­ì—ì„œ ì„ íƒí•œ 1ê°œ ì„¤ë¬¸(êµìœ¡í”„ë¡œê·¸ë¨)ì— ëŒ€í•´ì„œ ì„¤ë¬¸ì‘ë‹µì„ ëª¨ë‘ ë³´ì—¬ì¤Œ.
  - í•˜ë‹¨ì˜ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ì€ XLS íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œë°›ê²Œ í•¨. 
    í¸ì˜ë¥¼ ìœ„í•´ í˜„ì¬ í™”ë©´ì˜ ë°ì´í„° ì´ì™¸ì— í•´ë‹¹ ì„¼í„°ì˜ ì‘ë‹µ ë°ì´í„°ë¥¼ í•œêº¼ë²ˆì— ë‹¤ìš´ë¡œë“œ ë°›ìŒ.

=== ìµœì´ˆ ì„¤ì¹˜ ë°©ë²• (ì‹œìŠ¤í…œ ê´€ë¦¬ììš©) ===

0. ë³¸ í”„ë¡œê·¸ë¨ì€ php, jsp, python ê³¼ ê°™ì€ Server Side Program ì´ ì—†ìœ¼ë©°, HTML + Javascript ë¡œë§Œ ì‘ì„±ë˜ì–´ ì•„ë¬´ ì›¹ì„œë²„ì—ì„œë‚˜ ì‘ë™í•¨. ë¡œì»¬ pc ë‚´ì—ì„œë„ ì‘ë™í•¨. ë‹¨ ì¸í„°ë„·ì€ ì—°ê²°ë˜ì–´ ìˆì–´ì•¼ í•¨.
1. supabaseì—ì„œ ê¸°ì••í•˜ê³  anon keyë¥¼ ë°œê¸‰ë°›ìŒ. 
2. ë°œê¸‰ë°›ì€ í‚¤ë¥¼ ì†ŒìŠ¤ì½”ë“œì— ì…ë ¥ (ê¸°ì¡´ í‚¤ ìˆ˜ì •)
3. supabaseì—ì„œ Authentication ë©”ë‰´ì—ì„œ Users ìƒì„± (ì§ì›ìš© ê³„ì •)
4. supabaseì—ì„œ ì•„ë˜ì™€ ê°™ì´ í…Œì´ë¸” ìƒì„±í•˜ê³  ê¶Œí•œ ì„¤ì • 

-- êµìœ¡ ì •ë³´ í…Œì´ë¸”
CREATE TABLE IF NOT EXISTS education_info (
id SERIAL PRIMARY KEY,
unique_key VARCHAR(50) UNIQUE NOT NULL,
user_id UUID,
center_name VARCHAR(100) NOT NULL,
instructor_name VARCHAR(100) NOT NULL,
education_name VARCHAR(200) NOT NULL,
start_date DATE,
end_date DATE,
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ì„¤ë¬¸ ê²°ê³¼ í…Œì´ë¸”
CREATE TABLE IF NOT EXISTS survey_results (
id SERIAL PRIMARY KEY,
submitted_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
unique_key VARCHAR(50) REFERENCES education_info(unique_key),
instructor_name VARCHAR(10),
education_name VARCHAR(200),
center_name VARCHAR(10),
respondent_name VARCHAR(20),
gender VARCHAR(4),
age_group VARCHAR(10),
q1_rating INTEGER CHECK (q1_rating >= 1 AND q1_rating <= 5),
q2_rating INTEGER CHECK (q2_rating >= 1 AND q2_rating <= 5),
q3_rating INTEGER CHECK (q3_rating >= 1 AND q3_rating <= 5),
q4_rating INTEGER CHECK (q4_rating >= 1 AND q4_rating <= 5),
q5_rating INTEGER CHECK (q5_rating >= 1 AND q5_rating <= 5),
q6_rating INTEGER CHECK (q6_rating >= 1 AND q6_rating <= 5),
q7_rating INTEGER CHECK (q7_rating >= 1 AND q7_rating <= 5),
q8_rating INTEGER CHECK (q8_rating >= 1 AND q8_rating <= 5),
q9_rating INTEGER CHECK (q9_rating >= 1 AND q9_rating <= 5),
q10_rating INTEGER CHECK (q10_rating >= 1 AND q10_rating <= 5),
additional_comments TEXT,
);

-- RLS(Row Level Security) ì •ì±… ì„¤ì • 
ALTER TABLE education_info ENABLE ROW LEVEL SECURITY;
ALTER TABLE survey_results ENABLE ROW LEVEL SECURITY;
-- ì‚¬ìš©ì ê¶Œí•œ ì„¤ì •
CREATE POLICY "ëª¨ë‘ ì½ê¸° ê°€ëŠ¥" ON education_info FOR SELECT USING (true);
CREATE POLICY "ì¸ì¦ì‚¬ìš©ìëŠ” ë°ì´í„° ì¶”ê°€ ê°€ëŠ¥" ON education_info FOR INSERT WITH CHECK ( auth.uid() IS NOT NULL );
CREATE POLICY "ì¸ì¦ì‚¬ìš©ìëŠ” ìê¸° ë°ì´í„°ë§Œ ìˆ˜ì • ê°€ëŠ¥" ON education_info FOR UPDATE USING ( auth.uid() IN (ì „ì²´ê´€ë¦¬ìID) OR user_id = auth.uid() );
CREATE POLICY "ì¸ì¦ì‚¬ìš©ìëŠ” ìê¸° ë°ì´í„°ë§Œ ì‚­ì œ ê°€ëŠ¥" ON education_info FOR DELETE USING ( auth.uid() IN (ì „ì²´ê´€ë¦¬ìID) OR user_id = auth.uid() );
CREATE POLICY "ëª¨ë‘ ì¶”ê°€ ê°€ëŠ¥" ON survey_results FOR INSERT WITH CHECK (true);
CREATE POLICY "ì¸ì¦ì‚¬ìš©ìëŠ” ì „ì²´ ë°ì´í„° ìˆ˜ì • ê°€ëŠ¥" ON survey_results FOR ALL USING ( auth.uid() is not null) with check (auth.uid() is not null);

-- ì „ì²´ í†µê³„ í•¨ìˆ˜
CREATE OR REPLACE FUNCTION get_survey_stats(
  center_filter TEXT DEFAULT NULL,
  instructor_filter TEXT DEFAULT NULL,
  education_filter TEXT DEFAULT NULL
)
RETURNS TABLE(
  total_responses BIGINT,
  avg_rating NUMERIC(3,1),
  instructor_rating NUMERIC(3,1),
  unique_educations BIGINT
) 
LANGUAGE plpgsql
AS $$
BEGIN
  RETURN QUERY
  WITH filtered_results AS (
    SELECT 
      unique_key, center_name, instructor_name, education_name,
      q1_rating, q2_rating, q3_rating, q4_rating, q5_rating,
      q6_rating, q7_rating, q8_rating, q9_rating, q10_rating
    FROM survey_results
    WHERE 
      (center_filter IS NULL OR center_name ILIKE '%' || center_filter || '%')
      AND (instructor_filter IS NULL OR instructor_name ILIKE '%' || instructor_filter || '%')
      AND (education_filter IS NULL OR education_name ILIKE '%' || education_filter || '%')
  ),
  stats AS (
    SELECT 
      COUNT(*) as total_count,
      AVG((q1_rating + q2_rating + q3_rating + q4_rating + q5_rating + 
           q6_rating + q7_rating + q8_rating + q9_rating + q10_rating) / 10.0) as average_rating,
      AVG((q5_rating + q6_rating + q7_rating + q8_rating) / 4.0) as instructor_rating
    FROM filtered_results
  ),
  unique_count AS (
    SELECT COUNT(DISTINCT unique_key) as unique_edu_count
    FROM filtered_results
  )
  SELECT 
    stats.total_count,
    ROUND(stats.average_rating, 1),
    ROUND(stats.instructor_rating, 1),
    unique_count.unique_edu_count
  FROM stats, unique_count;
END;
$$;

-- êµìœ¡ë³„ í†µê³„ë¥¼ ìœ„í•œ ë·°
CREATE VIEW edu_survey_view AS
SELECT 
    ei.id,
    ei.unique_key,
    ei.center_name,
    ei.instructor_name,
    ei.education_name,
    COALESCE(sr.survey_cnt, 0) as survey_cnt,
    COALESCE(sr.avg_score, 0.0) as avg_score,
    COALESCE(sr.avg_inst_score, 0.0) as avg_inst_score
FROM education_info ei
LEFT JOIN (
    SELECT 
        unique_key,
        COUNT(*) as survey_cnt,
        ROUND(
            AVG(
                (q1_rating + q2_rating + q3_rating + q4_rating + q5_rating + 
                 q6_rating + q7_rating + q8_rating + q9_rating + q10_rating) / 10.0
            ), 1
        ) as avg_score,
        ROUND(
            AVG(
                (q5_rating + q6_rating + q7_rating + q8_rating) / 4.0
            ), 1
        ) as avg_inst_score
    FROM survey_results 
    GROUP BY unique_key
) sr ON ei.unique_key = sr.unique_key;

-- VIEW ì¡°íšŒ ê¶Œí•œ ë¶€ì—¬
GRANT SELECT ON edu_survey_view TO anon, authenticated;

5. ì„¤ì¹˜ í›„ ì´ í™”ë©´ ì•„ë˜ì˜ 'ì—°ê²° í…ŒìŠ¤íŠ¸' ë²„íŠ¼ì„ ëˆŒëŸ¬ DB ì ‘ì†ì´ ë˜ëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆìŒ.
    </textarea>
            <button class="btn" onclick="testConnection()">ì—°ê²° í…ŒìŠ¤íŠ¸</button>
            <div id="connectionStatus"></div>
          </div>
        </div>

        <!-- ê´€ë¦¬ì í™”ë©´1: êµìœ¡ ê´€ë¦¬ -->
        <div id="admin1" class="page">
          <h2>ğŸ“‹ êµìœ¡ ê²€ìƒ‰</h2>
          <div id="education-search-ui"></div>
          <div style="text-align: right">
            <button class="btn" onclick="openEducationModal('add')">
              ì‹ ê·œ ë“±ë¡
            </button>
          </div>

          <div
            id="educationCount"
            style="margin-bottom: 10px; font-weight: bold"
          ></div>
          <div id="educationList" class="scrollable-list">
            <div class="loading">
              <div class="spinner"></div>
              <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
          </div>
        </div>

        <!-- ê´€ë¦¬ì í™”ë©´2: ì„¤ë¬¸ í˜„í™© -->
        <div id="admin2" class="page">
          <h2>ğŸ“Š ì„¤ë¬¸ ê²€ìƒ‰</h2>
          <div id="survey-search-ui"></div>

          <h2>ğŸ“Š ê²€ìƒ‰ ê²°ê³¼</h2>
          <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
              <div class="stat-number" id="uniqueEducations">0</div>
              <div>êµìœ¡ ê³¼ì •</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="totalResponses">0</div>
              <div>ì´ ì‘ë‹µ ìˆ˜</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="avgRating">0.0</div>
              <div>í‰ê·  ë§Œì¡±ë„</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="instructorRating">0.0</div>
              <div>ê°•ì‚¬ ë§Œì¡±ë„</div>
            </div>
          </div>

          <div id="surveyResults" class="scrollable-list">
            <div class="loading">
              <div class="spinner"></div>
              <p>ì„¤ë¬¸ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
          </div>
        </div>

        <!-- ê´€ë¦¬ì í™”ë©´3: ì‘ë‹µ ë‚´ì—­ -->
        <div id="survey" class="page">

          <div id="surveyDetailDiv"></div>
          <div id="ResultAlertDiv"></div>

        </div>
      </div>
    </div>

    <!-- êµìœ¡ì •ë³´ ëª¨ë‹¬ -->
    <div id="educationModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeEducationModal()">&times;</span>
        <h3 id="modalTitle">êµìœ¡ ì •ë³´</h3>
        <div class="form-group">
          <label>ì„¼í„°ëª…:</label>
          <select id="modalCenter">
            <option value="ë¶€ì‚°ì„¼í„°">ë¶€ì‚°ì„¼í„°</option>
            <option value="ê²½ë‚¨ì„¼í„°">ê²½ë‚¨ì„¼í„°</option>
            <option value="ìš¸ì‚°ì„¼í„°">ìš¸ì‚°ì„¼í„°</option>
          </select>
        </div>
        <div class="form-group">
          <label>ê°•ì‚¬ëª…:</label>
          <input type="text" id="modalInstructor" />
        </div>
        <div class="form-group">
          <label>êµìœ¡ëª…:</label>
          <input type="text" id="modalEducation" />
        </div>
        <div class="form-group">
          <label>ì„¤ë¬¸ê¸°ê°„:</label>
          <input type="text" id="modalStartDate" /> ~
          <input type="text" id="modalEndDate" />
        </div>
        <div style="margin-top: 20px">
          <button
            class="btn"
            id="modalActionButton"
            onclick="handleEducationAction()"
          >
            ë“±ë¡
          </button>
          <button class="btn btn-secondary" onclick="closeEducationModal()">
            ì·¨ì†Œ
          </button>
        </div>
      </div>
    </div>

    <script>
// ì„¤ë¬¸íŒŒì¼ ìœ„ì¹˜
// var survey_url = 'https://kcmf.or.kr/survey.html';
var survey_url = String(window.location.href).replace('/manager.html', '/survey.html');

// DB ì ‘ì† ë° ìƒì„±
var supabase = supabase.createClient('https://fnxmyayfosjwuvsxbabm.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZueG15YXlmb3Nqd3V2c3hiYWJtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk2MTg2NzcsImV4cCI6MjA2NTE5NDY3N30.rAldXcD4_tsstfd9xHzKw3QgIHBrHvaFkBv6TJRVhjA')

// Supabase ì—°ê²° í…ŒìŠ¤íŠ¸
async function testConnection() {
    try {
        const { data, error } = await supabase.from('education_info').select('count').limit(1);
        if (error) throw error;
        showAlert('ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í…ŒìŠ¤íŠ¸ ì„±ê³µ!', 'success');
    } catch (error) {
        showAlert('ë°ì´í„°ë² ì´ìŠ¤ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ' + error.message, 'error');
    }
}

// ì•Œë¦¼ í‘œì‹œ
function showAlert(message, type) {
    const statusDiv = document.getElementById('connectionStatus');
    statusDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
    setTimeout(() => {
        statusDiv.innerHTML = '';
    }, 5000);
}

// ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¼ ë¡œê·¸ì¸ í™œì„±í™”/ë¹„í™œì„±í™”
function updateLoginUI(isLoggedIn = false) {
    const emailInput = document.getElementById('login_email');
    const passwordInput = document.getElementById('login_password');
    const loginBtn = document.getElementById('login_btn');
    const logoutBtn = document.getElementById('logout_btn');
    if (isLoggedIn) {
        emailInput.readOnly = true;
        emailInput.style.backgroundColor = '#ddd';
        passwordInput.readOnly = true;
        passwordInput.style.backgroundColor = '#ddd';
        loginBtn.className = 'btn btn-secondary';
        logoutBtn.className = 'btn';
    } else {
        emailInput.readOnly = false;
        emailInput.style.backgroundColor = 'white';
        passwordInput.value = '';
        passwordInput.readOnly = false;
        passwordInput.style.backgroundColor = 'white';
        loginBtn.className = 'btn';
        logoutBtn.className = 'btn btn-secondary';
    }
}


// ë¡œê·¸ì¸ í•¨ìˆ˜
async function signIn() {
    const email = document.getElementById('login_email').value;
    const password = document.getElementById('login_password').value;
    const { data, error } = await supabase.auth.signInWithPassword({
        email: email,
        password: password
    });

    if (error) {
        document.getElementById('authStatus').innerText = 'ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + error.message;
    } else {
        document.getElementById('authStatus').innerText = 'ë¡œê·¸ì¸ ì„±ê³µ! ì‚¬ìš©ì ID: ' + data.user.id;
        updateLoginUI(true);
        showPage('admin1');
    }
}

// ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜
async function signOut() {
    const { error } = await supabase.auth.signOut();
    if (error) {
        document.getElementById('authStatus').innerText = 'ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨: ' + error.message;
    } else {
        document.getElementById('authStatus').innerText = 'ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.';
        updateLoginUI(false);
    }
}

// ë¡œê·¸ì¸ ìƒíƒœ ë³€í™” ê°ì§€
supabase.auth.onAuthStateChange(async (event, session) => {
    if (session && session.user) {
        document.getElementById('authStatus').innerText = `ë¡œê·¸ì¸ ìƒíƒœ: ${session.user.id}`;
        updateLoginUI(true);
        showPage('admin1');
    } else {
        document.getElementById('authStatus').innerText = 'ë¡œê·¸ì¸ ìƒíƒœ: ë¡œê·¸ì•„ì›ƒë¨';
        updateLoginUI(false);
        showPage('config');
    }
});

// í˜ì´ì§€ ì „í™˜
async function showPage(pageId) {

    // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ (ë¡œê·¸ì¸ ì•ˆí–ˆìœ¼ë©´ ì„¤ì • í™”ë©´ìœ¼ë¡œ ì´ë™)
    const { data: { session } } = await supabase.auth.getSession();
    if (!session || !session.user) pageId = "config";

    // ëª¨ë“  í˜ì´ì§€ ìˆ¨ê¸°ê¸°
    document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
    });

    // ëª¨ë“  íƒ­ ë¹„í™œì„±í™”
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
    });

    // ì„ íƒëœ í˜ì´ì§€ í‘œì‹œ
    document.getElementById(pageId).classList.add('active');
    const activeTab = document.querySelector(`.nav-tab[data-page="${pageId}"]`);
    if (activeTab) activeTab.classList.add('active');

    // í˜ì´ì§€ë³„ ì´ˆê¸° í™”ë©´ ë¡œë”© (ìµœì´ˆ ì§„ì… ì‹œì• ë§Œ)
    if (pageId === 'admin1') {
      const searchUI = document.getElementById('education-search-ui');
      if (!searchUI.hasChildNodes()) {
        educationPage = 0;
        currentEducations = [];
        // ê¸°ì¡´ ìŠ¤í¬ë¡¤ ë¦¬ìŠ¤ë„ˆ ì œê±° (ì¤‘ë³µ ë°©ì§€)
        const listDiv = document.getElementById('educationList');
        if (listDiv && listDiv.hasScrollListener) {
            listDiv.removeEventListener('scroll', handleEducationScroll);
            listDiv.hasScrollListener = false;
        }
        // ê²€ìƒ‰ ì¸í„°í˜ì´ìŠ¤ ìƒì„±
        createSearchInterface(
            'education-search-ui',
            (filters) => { // ê²€ìƒ‰ ì½œë°±
                educationPage = 0;
                currentEducations = [];
                loadEducations(filters);
            },
            () => { // ì´ˆê¸°í™” ì½œë°±
                educationPage = 0;
                currentEducations = [];
                loadEducations();
            }
          );
          loadEducations();
      }
    } else if (pageId === 'admin2') {
      // ê²€ìƒ‰ ì¸í„°í˜ì´ìŠ¤ê°€ ì—†ì„ ë•Œë§Œ ìƒì„± (ìµœì´ˆ ì§„ì…)
      const searchUI = document.getElementById('survey-search-ui');
      if (!searchUI.hasChildNodes()) {
        surveyPage = 0;
        currentSurveyResults = [];
        // ê¸°ì¡´ ìŠ¤í¬ë¡¤ ë¦¬ìŠ¤ë„ˆ ì œê±° (ì¤‘ë³µ ë°©ì§€)
        const surveyDiv = document.getElementById('surveyResults');
        if (surveyDiv && surveyDiv.hasScrollListener) {
            surveyDiv.removeEventListener('scroll', handleSurveyScroll);
            surveyDiv.hasScrollListener = false;
        }
        // ê²€ìƒ‰ ì¸í„°í˜ì´ìŠ¤ ìƒì„±
        createSearchInterface(
            'survey-search-ui',
            (filters) => { // ê²€ìƒ‰ ì½œë°±
                surveyPage = 0;
                currentSurveyResults = [];
                loadSurveyResults(filters);
            },
            () => { // ì´ˆê¸°í™” ì½œë°±
                surveyPage = 0;
                currentSurveyResults = [];
                loadSurveyResults();
            }
        );
        loadSurveyResults();
      }
    } else {
        // ë‹¤ë¥¸ í˜ì´ì§€ë¡œ ì´ë™í•  ë•Œ ìƒíƒœ ì •ë¦¬
        const listDiv = document.getElementById('educationList');
        if (listDiv && listDiv.hasScrollListener) {
            listDiv.removeEventListener('scroll', handleEducationScroll);
            listDiv.hasScrollListener = false;
        }
        const surveyDiv = document.getElementById('surveyResults');
        if (surveyDiv && surveyDiv.hasScrollListener) {
            surveyDiv.removeEventListener('scroll', handleSurveyScroll);
            surveyDiv.hasScrollListener = false;
        }
        window.isLoadingEducations = false;
        window.isLoadingSurveys = false;
    }
}

function generateUniqueKey(center, instructor) {
    // ë¬¸ìì—´ ê¸¸ì´ ê¸°ë°˜ ê°„ë‹¨í•œ í•´ì‹œ (ê° ë¬¸ìì˜ ì½”ë“œê°’ í•©ì‚°)
    let hash = center.length + instructor.length;
    for (let i = 0; i < center.length; i++) {
        hash += center.charCodeAt(i);
    }
    for (let i = 0; i < instructor.length; i++) {
        hash += instructor.charCodeAt(i);
    }
    // 36ì§„ë²•ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ì§§ê²Œ ë§Œë“¤ê¸°
    const hashStr = (hash % 1679616).toString(36); // 1679616 = 36^4, ìµœëŒ€ 4ìë¦¬
    // í˜„ì¬ ì‹œê°„ì—ì„œ 2000ë…„ì„ ë¹¼ë²„ë¦¬ë©´ ë‚¨ì€ ìˆ«ìê°€ ì¤„ì–´ë“ ë‹¤
    const now = Date.now();
    const year2000 = new Date('2000-01-01').getTime();
    const timeStr = (now - year2000).toString(36);
    return `${hashStr}${timeStr}`;
}

let editingEducationId = null; // ìˆ˜ì • ëª¨ë“œì¼ ë•Œë§Œ ì‚¬ìš©
let modalMode = 'add'; // êµìœ¡ ì¶”ê°€ ìˆ˜ì • ì‹œ 'add' ë˜ëŠ” 'edit' ëª¨ë“œ

const recordsPerPage = 50; // í˜ì´ì§€ë‹¹ ë ˆì½”ë“œ ìˆ˜

// êµìœ¡ ê´€ë¦¬ ê´€ë ¨ ì „ì—­ ë³€ìˆ˜
let educationPage = 0; 
let educationIsLoading = false;
let educationHasMore = true;
let currentEducations = [];

// ì„¤ë¬¸ í˜„í™© ê´€ë ¨ ì „ì—­ ë³€ìˆ˜
let surveyPage = 0;
let surveyIsLoading = false;
let surveyHasMore = true;
let currentSurveyResults = [];

/**
 * ì¬ì‚¬ìš© ê°€ëŠ¥í•œ ê²€ìƒ‰ UIë¥¼ ìƒì„±í•˜ê³  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì—°ê²°í•©ë‹ˆë‹¤.
 * @param {string} containerId - ê²€ìƒ‰ UIê°€ ì‚½ì…ë  divì˜ ID
 * @param {function} onSearch - 'ê²€ìƒ‰' ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰ë  ì½œë°± í•¨ìˆ˜
 * @param {function} onReset - 'ì´ˆê¸°í™”' ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰ë  ì½œë°± í•¨ìˆ˜
 */
function createSearchInterface(containerId, onSearch, onReset) {
    const container = document.getElementById(containerId);
    if (!container) return;

    // ê²€ìƒ‰ UIì˜ HTML êµ¬ì¡°
    container.innerHTML = `
    <div class="form-group" style="margin-top: 20px; margin-bottom: 20px; padding: 20px; background: #f8fafc; border-radius: 8px;">
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
        <div class="form-group">
          <label>ì„¼í„°ëª…:</label>
          <!--<input type="text" class="search-center" placeholder="ì„¼í„°ëª… ì…ë ¥">-->
          <select class="search-center">
            <option value="">--ì „ì²´--</option>
            <option value="ë¶€ì‚°ì„¼í„°">ë¶€ì‚°ì„¼í„°</option>
            <option value="ê²½ë‚¨ì„¼í„°">ê²½ë‚¨ì„¼í„°</option>
            <option value="ìš¸ì‚°ì„¼í„°">ìš¸ì‚°ì„¼í„°</option>
          </select>
        </div>
        <div class="form-group">
          <label>ê°•ì‚¬ëª…:</label>
          <input type="text" class="search-instructor" placeholder="ê°•ì‚¬ëª… ì…ë ¥">
        </div>
        <div class="form-group">
          <label>êµìœ¡ëª…:</label>
          <input type="text" class="search-education" placeholder="êµìœ¡ëª… ì…ë ¥">
        </div>
      </div>
      <button class="btn search-btn">ê²€ìƒ‰</button>
      <button class="btn btn-secondary reset-btn">ê²€ìƒ‰ ì´ˆê¸°í™”</button>
    </div>
    `;

    // ìƒì„±ëœ UI ë‚´ì˜ ìš”ì†Œì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
    const searchBtn = container.querySelector('.search-btn');
    const resetBtn = container.querySelector('.reset-btn');
    const centerInput = container.querySelector('.search-center');
    const instructorInput = container.querySelector('.search-instructor');
    const educationInput = container.querySelector('.search-education');

    // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    searchBtn.addEventListener('click', () => {
        const filters = {
            center: centerInput.value,
            instructor: instructorInput.value,
            education: educationInput.value,
        };
        onSearch(filters); // ì „ë‹¬ë°›ì€ onSearch ì½œë°± í•¨ìˆ˜ ì‹¤í–‰
    });

    // ì´ˆê¸°í™” ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    resetBtn.addEventListener('click', () => {
        centerInput.value = '';
        instructorInput.value = '';
        educationInput.value = '';
        onReset(); // ì „ë‹¬ë°›ì€ onReset ì½œë°± í•¨ìˆ˜ ì‹¤í–‰
    });
}

// êµìœ¡ ëª©ë¡ ë¡œë“œ (ê²€ìƒ‰ ë° í˜ì´ì§• ì ìš©)
async function loadEducations(filters = {}) {
    if (educationIsLoading) return;
    educationIsLoading = true;

    if (!supabase) {
        document.getElementById('educationList').innerHTML = '<div class="alert alert-error">ë¨¼ì € Supabaseì— ì—°ê²°í•´ì£¼ì„¸ìš”.</div>';
        return;
    }

    const listDiv = document.getElementById('educationList');
    const loadingDiv = listDiv.querySelector('.loading');
    if (loadingDiv) loadingDiv.style.display = 'block';

    // ê²€ìƒ‰ ì‹œ ë˜ëŠ” ì²« ë¡œë“œ ì‹œ currentEducations ì´ˆê¸°í™”
    if (educationPage === 0) {
        currentEducations = [];
        listDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>';
    }

    // ì´ë¯¸ ë¡œë”© ì¤‘ì¸ì§€ í™•ì¸í•˜ì—¬ ì¤‘ë³µ ìš”ì²­ ë°©ì§€
    if (window.isLoadingEducations) {
        return;
    }
    window.isLoadingEducations = true;

    let query = supabase.from('education_info').select('*', { count: 'exact' });

    // ê²€ìƒ‰ ì¡°ê±´ ì¶”ê°€
    if (filters.center) {
        query = query.ilike('center_name', `%${filters.center}%`);
    }
    if (filters.instructor) {
        query = query.ilike('instructor_name', `%${filters.instructor}%`);
    }
    if (filters.education) {
        query = query.ilike('education_name', `%${filters.education}%`);
    }

    // í˜ì´ì§• ì ìš©
    const from = educationPage * recordsPerPage;
    const to = from + recordsPerPage - 1;
    query = query.order('created_at', { ascending: false }).range(from, to);

    try {
        const { data, error, count } = await query;
        if (error) throw error;

        currentEducations = currentEducations.concat(data); // ìƒˆë¡œ ë¶ˆëŸ¬ì˜¨ ë°ì´í„°ë¥¼ ê¸°ì¡´ ë°ì´í„°ì— ì¶”ê°€

        displayEducations(currentEducations, count, educationPage === 0); // isInitialRender í”Œë˜ê·¸ ì¶”ê°€

        if (loadingDiv) loadingDiv.style.display = 'none';

        // ìŠ¤í¬ë¡¤ ë¡œë“œë¥¼ ìœ„í•œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ìµœì´ˆ ë¡œë“œ ì‹œì—ë§Œ)
        if (!listDiv.hasScrollListener) {
            listDiv.addEventListener('scroll', handleEducationScroll);
            listDiv.hasScrollListener = true;
        }
        window.isLoadingEducations = false; // ë¡œë”© ìƒíƒœ í•´ì œ

    } catch (error) {
        document.getElementById('educationList').innerHTML = `<div class="alert alert-error">ë¡œë”© ì‹¤íŒ¨: ${error.message}</div>`;
        if (loadingDiv) loadingDiv.style.display = 'none';

    } finally {
        educationIsLoading = false;
    }
}

// êµìœ¡ ëª©ë¡ í‘œì‹œ (ê²€ìƒ‰ ê±´ìˆ˜ ì—…ë°ì´íŠ¸ í¬í•¨)
function displayEducations(educations, totalCount, isInitialRender = false) {
    const listDiv = document.getElementById('educationList');
    const educationCountDiv = document.getElementById('educationCount');

    educationCountDiv.textContent = `ì´ ${totalCount}ê±´ì˜ êµìœ¡ ê³¼ì •ì´ ê²€ìƒ‰ë˜ì—ˆìŠµë‹ˆë‹¤.`;

    if (educations.length === 0) {
        listDiv.innerHTML = '<div class="alert alert-info">ë“±ë¡ëœ êµìœ¡ ê³¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
    }

    let html = `
    <table class="table">
    <thead>
    <tr>
    <th width="12%">ì„¼í„°</th>
    <th width="11%">ê°•ì‚¬ëª…</th>
    <th width="28%">êµìœ¡ëª…</th>
    <th width="14%">ì„¤ë¬¸ê¸°ê°„</th>
    <th width="17%">ì„¤ë¬¸ URL<br/>(ê³ ìœ í‚¤)</th>
    <th width="18%">ì‘ì—…</th>
    </tr>
    </thead>
    <tbody>
    `;

    educations.forEach(edu => {
        html += `
    <tr>
    <td><code>${edu.center_name}</code></td>
    <td>${edu.instructor_name}</td>
    <td>${edu.education_name}</td>
    <td><code>${edu.start_date}<br/>~${edu.end_date}</code></td>
    <td><a href="${survey_url}#s=${edu.unique_key}" target="_blank" style="color: #4f46e5;">${edu.unique_key}</a></td>
    <td>
    <button class="btn" onclick="openEducationModal('edit', ${edu.id})" style="padding: 5px 10px; font-size: 0.8rem;">ìˆ˜ì •</button>
    <button class="btn btn-danger" onclick="deleteEducation(${edu.id},'${edu.unique_key}')" style="padding: 5px 10px; font-size: 0.8rem;">ì‚­ì œ</button>
    </td>
    </tr>
    `;
    });

    html += '</tbody></table>';
    listDiv.innerHTML = html;
}

// êµìœ¡ ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
function handleEducationScroll() {
    const listDiv = document.getElementById('educationList');
    // ì´ë¯¸ ë¡œë”© ì¤‘ì´ë©´ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
    if (window.isLoadingEducations) return;
    // ìŠ¤í¬ë¡¤ì´ ëì—ì„œ 50px ì •ë„ê¹Œì§€ ê°€ë©´ ì¶”ê°€ ë¡œë“œ
    if (listDiv.scrollTop + listDiv.clientHeight >= listDiv.scrollHeight - 50) {
        educationPage++;
        loadEducations();
    }
}

// êµìœ¡ ì •ë³´ ëª¨ë‹¬ ì—´ê¸° (ì¶”ê°€/ìˆ˜ì • ê²¸ìš©)
function openEducationModal(mode, id = null) {
    modalMode = mode;
    const modalTitle = document.getElementById('modalTitle');
    const modalActionButton = document.getElementById('modalActionButton');

    // í•„ë“œ ì´ˆê¸°í™”
    document.getElementById('modalCenter').selectedIndex = 0;
    document.getElementById('modalInstructor').value = '';
    document.getElementById('modalEducation').value = '';
    document.getElementById('modalStartDate').value = '';
    document.getElementById('modalEndDate').value = '';
    editingEducationId = null; // ì´ˆê¸°í™”

    if (mode === 'add') {
        modalTitle.textContent = 'ìƒˆ êµìœ¡ ì •ë³´ ë“±ë¡';
        modalActionButton.textContent = 'ë“±ë¡';
        modalActionButton.onclick = addEducation; // ë“±ë¡ í•¨ìˆ˜ ì—°ê²°
        // ê¸°ë³¸ê°’ìœ¼ë¡œ ì˜¤ëŠ˜ ë‚ ì§œì™€ 4ì£¼í›„ ë‚ ì§œë¥¼ ì„¤ì • (YYYY-MM-DD)
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0'); // ì›”ì€ 0ë¶€í„° ì‹œì‘í•˜ë¯€ë¡œ +1
        const day = String(today.getDate()).padStart(2, '0');
        document.getElementById('modalStartDate').value = `${year}-${month}-${day}`;
        const fourWeeksLater = new Date();
        fourWeeksLater.setDate(today.getDate() + 28); // ì˜¤ëŠ˜ ë‚ ì§œì— 28ì¼ (4ì£¼) ë”í•˜ê¸°
        const endYear = fourWeeksLater.getFullYear();
        const endMonth = String(fourWeeksLater.getMonth() + 1).padStart(2, '0');
        const endDay = String(fourWeeksLater.getDate()).padStart(2, '0');
        document.getElementById('modalEndDate').value = `${endYear}-${endMonth}-${endDay}`;

    } else if (mode === 'edit') {
        modalTitle.textContent = 'êµìœ¡ ì •ë³´ ìˆ˜ì •';
        modalActionButton.textContent = 'ìˆ˜ì •';
        modalActionButton.onclick = updateEducation; // ìˆ˜ì • í•¨ìˆ˜ ì—°ê²°

        const education = currentEducations.find(edu => edu.id === id);
        if (!education) {
            showAlert('ìˆ˜ì •í•  êµìœ¡ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
            return;
        }
        editingEducationId = id;
        // document.getElementById('modalCenter').value = education.center_name;
        const modalCenter = document.getElementById('modalCenter');
        console.log(education);
        modalCenter.value = education.center_name;
        if (modalCenter.value !== education.center_name) {
            for (let i = 0; i < modalCenter.options.length; i++) {
                if (modalCenter.options[i].value === education.center_name) {
                    modalCenter.selectedIndex = i;
                    break;
                }
            }
        }
        console.log(modalCenter.value, education.center_name);
        document.getElementById('modalInstructor').value = education.instructor_name;
        document.getElementById('modalEducation').value = education.education_name;
        document.getElementById('modalStartDate').value = education.start_date;
        document.getElementById('modalEndDate').value = education.end_date;
    }
    document.getElementById('educationModal').style.display = 'block';
}

// êµìœ¡ ì •ë³´ ëª¨ë‹¬ ë‹«ê¸°
function closeEducationModal() {
    document.getElementById('educationModal').style.display = 'none';
}

// ëª¨ë‹¬ ì•¡ì…˜ í•¸ë“¤ëŸ¬ (ì¶”ê°€ ë˜ëŠ” ìˆ˜ì • í•¨ìˆ˜ë¥¼ í˜¸ì¶œ)
function handleEducationAction() {
    if (modalMode === 'add') {
        addEducation();
    } else if (modalMode === 'edit') {
        updateEducation();
    }
}

// êµìœ¡ ì •ë³´ ì¶”ê°€
async function addEducation() {
    if (!supabase) {
        showAlert('ë¨¼ì € Supabaseì— ì—°ê²°í•´ì£¼ì„¸ìš”.', 'error');
        return;
    }

    const instructor = document.getElementById('modalInstructor').value;
    const education = document.getElementById('modalEducation').value;
    const center = document.getElementById('modalCenter').value;
    const uniqueKey = generateUniqueKey(instructor, education, center);
    const start_date = document.getElementById('modalStartDate').value;
    const end_date = document.getElementById('modalEndDate').value;

    if (!instructor || !education || !center || !start_date || !end_date) {
        showAlert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
        return;
    }

    try {
        const { data, error } = await supabase
            .from('education_info')
            .insert([{
                unique_key: uniqueKey,
                center_name: center,
                instructor_name: instructor,
                education_name: education,
                start_date: start_date,
                end_date: end_date
            }]);

        if (error) throw error;

        showAlert('êµìœ¡ ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        closeEducationModal();
        educationPage = 0;
        currentEducations = [];
        loadEducations();
    } catch (error) {
        showAlert('ì¶”ê°€ ì‹¤íŒ¨: ' + error.message, 'error');
    }
}

// êµìœ¡ ì •ë³´ ì—…ë°ì´íŠ¸
// ì£¼ì˜: unique_key ê°’ì€ ë³€ê²½í•˜ì§€ ì•ŠëŠ”ë‹¤. (ë³€ê²½í•˜ë©´ ê¸°ì¡´ ì„¤ë¬¸ì€ ëª¨ë‘ ë¬´íš¨ê°€ ë¨.)
async function updateEducation() {
    const center = document.getElementById('modalCenter').value;
    const instructor = document.getElementById('modalInstructor').value;
    const education = document.getElementById('modalEducation').value;
    const start_date = document.getElementById('modalStartDate').value;
    const end_date = document.getElementById('modalEndDate').value;

    if (!instructor || !education || !center || !start_date || !end_date) {
        showAlert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
        return;
    }

    try {
        const { data, error } = await supabase
            .from('education_info')
            .update({
                center_name: center,
                instructor_name: instructor,
                education_name: education,
                start_date: start_date,
                end_date: end_date,
            })
            .eq('id', editingEducationId);

        if (error) throw error;

        showAlert('êµìœ¡ ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        closeEducationModal();
        educationPage = 0;
        currentEducations = [];
        loadEducations();
    } catch (error) {
        showAlert('ìˆ˜ì • ì‹¤íŒ¨: ' + error.message, 'error');
    }
}

// ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸° (educationModal í•˜ë‚˜ë§Œ ì²˜ë¦¬)
window.onclick = function (event) {
    const educationModal = document.getElementById('educationModal');
    if (event.target === educationModal) {
        closeEducationModal();
    }
}

// êµìœ¡ ì •ë³´ ì‚­ì œ
// TODO: ì„¤ë¬¸ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì‚­ì œí•˜ë©´ ì•ˆë¨.
async function deleteEducation(id, unique_key) {
    if (!confirm('ì •ë§ë¡œ ì´ êµìœ¡ ì •ë³´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    try {
        const { data, error } = await supabase
            .from('education_info')
            .delete()
            .eq('id', id)
            .eq('unique_key', unique_key);

        if (error) throw error;

        showAlert('êµìœ¡ ì •ë³´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        educationPage = 0;
        currentEducations = [];
        loadEducations();
    } catch (error) {
        showAlert('ì‚­ì œ ì‹¤íŒ¨: ' + error.message, 'error');
    }
}

// í†µê³„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜(ì°¨ì„ ì±…: DBì—ì„œ ì§‘ê³„ ê³„ì‚°)
async function loadSurveyStats(filters = {}) {
    if (!supabase) return;
    try {
        // 1. ì „ì²´ ì‘ë‹µ ìˆ˜ì™€ í‰ê·  ì ìˆ˜ ê³„ì‚°
        let statsQuery = supabase
            .from('edu_survey_view')
             .select('*', { count: 'exact' });

        // ê²€ìƒ‰ ì¡°ê±´ ì ìš©
        if (filters.center) {
            statsQuery = statsQuery.ilike('center_name', `%${filters.center}%`);
        }
        if (filters.instructor) {
            statsQuery = statsQuery.ilike('instructor_name', `%${filters.instructor}%`);
        }
        if (filters.education) {
            statsQuery = statsQuery.ilike('education_name', `%${filters.education}%`);
        }

        const { data: statsData, error: statsError, count: totalCount } = await statsQuery;
        if (statsError) throw statsError;

      // í†µê³„ ê³„ì‚° ë°©ì‹ ë³€ê²½ (viewì˜ ì§‘ê³„ëœ ë°ì´í„° ì‚¬ìš©)
        let totalResponses = 0;
        let totalAvgScore = 0;
        let totalInstScore = 0;
        
        statsData.forEach(row => {
            totalResponses += row.survey_cnt;
            totalAvgScore += row.avg_score * row.survey_cnt;
            totalInstScore += row.avg_inst_score * row.survey_cnt;
        });

        // í†µê³„ ì—…ë°ì´íŠ¸
        document.getElementById('totalResponses').textContent = totalResponses;
        document.getElementById('avgRating').textContent = 
            totalResponses > 0 ? (totalAvgScore / totalResponses).toFixed(1) : '0.0';
        document.getElementById('instructorRating').textContent = 
            totalResponses > 0 ? (totalInstScore / totalResponses).toFixed(1) : '0.0';
        document.getElementById('uniqueEducations').textContent = statsData.length;

    } catch (error) {
        console.error('ì°¨ì„ ì±… í†µê³„ ë¡œë”© ì‹¤íŒ¨:', error);
    }
}

// í†µê³„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ìµœì í™” ë²„ì „ - PostgreSQLì˜ RPC í•¨ìˆ˜ ì‚¬ìš©)
async function loadSurveyStatsOptimized(filters = {}) {
    if (!supabase) return;
    try {
        // RPCë¥¼ ì‚¬ìš©í•˜ì—¬ ì„œë²„ì—ì„œ ëª¨ë“  ê³„ì‚° ìˆ˜í–‰
        const { data, error } = await supabase.rpc('get_survey_stats', {
            center_filter: filters.center || null,
            instructor_filter: filters.instructor || null,
            education_filter: filters.education || null
        });
        if (error) throw error;

        // ì„œë²„ì—ì„œ ê³„ì‚°ëœ ê²°ê³¼ ì§ì ‘ ì‚¬ìš©
        document.getElementById('totalResponses').textContent = data[0].total_responses;
        document.getElementById('avgRating').textContent = data[0].avg_rating;
        document.getElementById('instructorRating').textContent = data[0].instructor_rating;
        document.getElementById('uniqueEducations').textContent = data[0].unique_educations;

    } catch (error) {
        console.error('ìµœì„ ì±… í†µê³„ ë¡œë”© ì‹¤íŒ¨:', error);
        // RPC í•¨ìˆ˜ê°€ ì—†ëŠ” ê²½ìš° fallback (ìœ„ì˜ ì°¨ì„ ì±… ì‚¬ìš©)
        await loadSurveyStats(filters);
    }
}

// ê°œì„ ëœ ë©”ì¸ ë¡œë”© í•¨ìˆ˜
async function loadSurveyResults(filters = {}) {
    if (surveyIsLoading) return;
    surveyIsLoading = true;

    if (!supabase) {
        document.getElementById('surveyResults').innerHTML = 
            '<div class="alert alert-error">ë¨¼ì € Supabaseì— ì—°ê²°í•´ì£¼ì„¸ìš”.</div>';
        return;
    }

    const surveyResultsDiv = document.getElementById('surveyResults');
    
    // ê²€ìƒ‰ ì‹œ ë˜ëŠ” ì²« ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    if (surveyPage === 0) {
        currentSurveyResults = [];
        surveyResultsDiv.innerHTML = 
            '<div class="loading"><div class="spinner"></div><p>ì„¤ë¬¸ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>';
        
        // í†µê³„ëŠ” ë³„ë„ë¡œ ë¨¼ì € ë¡œë“œ (ë¹ ë¥¸ ì‘ë‹µ)
        loadSurveyStatsOptimized(filters);
    }

    if (window.isLoadingSurveys) return;
    window.isLoadingSurveys = true;

    try {
        
        // ë·°ë¥¼ ê²€ìƒ‰í•˜ëŠ” ê²ƒìœ¼ë¡œ ë³€ê²½
        let query = supabase.from('edu_survey_view').select('*');

        // ê²€ìƒ‰ ì¡°ê±´ ì¶”ê°€
        if (filters.center) {
            query = query.ilike('center_name', `%${filters.center}%`);
        }
        if (filters.instructor) {
            query = query.ilike('instructor_name', `%${filters.instructor}%`);
        }
        if (filters.education) {
            query = query.ilike('education_name', `%${filters.education}%`);
        }

        // í˜ì´ì§• ì ìš©
        const from = surveyPage * recordsPerPage;
        const to = from + recordsPerPage - 1;
        query = query.order('id', { ascending: false }).range(from, to);

        const { data, error } = await query;
        if (error) throw error;

        currentSurveyResults = currentSurveyResults.concat(data);
        displaySurveyResults(currentSurveyResults, surveyPage === 0);

        // í†µê³„ëŠ” ì´ë¯¸ ë¡œë“œí–ˆìœ¼ë¯€ë¡œ ìŠ¤í‚µ
        
        const loadingDiv = surveyResultsDiv.querySelector('.loading');
        if (loadingDiv) loadingDiv.style.display = 'none';

        // ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        if (!surveyResultsDiv.hasScrollListener) {
            surveyResultsDiv.addEventListener('scroll', handleSurveyScroll);
            surveyResultsDiv.hasScrollListener = true;
        }

    } catch (error) {
        surveyResultsDiv.innerHTML = 
            `<div class="alert alert-error">ë¡œë”© ì‹¤íŒ¨: ${error.message}</div>`;
    } finally {
        surveyIsLoading = false;
        window.isLoadingSurveys = false;
    }
}

// ì„¤ë¬¸ ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
function handleSurveyScroll() {
    const surveyDiv = document.getElementById('surveyResults');
    // ì´ë¯¸ ë¡œë”© ì¤‘ì´ë©´ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
    if (window.isLoadingSurveys) return;
    // ìŠ¤í¬ë¡¤ì´ ëì—ì„œ 50px ì •ë„ê¹Œì§€ ê°€ë©´ ì¶”ê°€ ë¡œë“œ
    if (surveyDiv.scrollTop + surveyDiv.clientHeight >= surveyDiv.scrollHeight - 50) {
        surveyPage++;
        loadSurveyResults();
    }
}

// ì‘ë‹µ ë‚´ì—­ í‘œì‹œ
function displaySurveyResults(results, isInitialRender = false) {
    const surveyResultsDiv = document.getElementById('surveyResults');

    if (results.length === 0) {
        surveyResultsDiv.innerHTML = '<div class="alert alert-info">ì‘ë‹µ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
    }

    let html = `
    <table class="table">
    <thead>
    <tr>
      <th width="12%">ì„¼í„°ëª…</th>
      <th width="12%">ê°•ì‚¬ëª…</th>
      <th width="28%">êµìœ¡ëª…</th>
      <th width="12%">ì‘ë‹µìˆ˜</th>
      <th width="12%">í‰ê· ì ìˆ˜</th>
      <th width="12%">ê°•ì‚¬ì ìˆ˜</th>
      <th width="12%">ìƒì„¸ë‚´ì—­</th>
    </tr>
    </thead>
    <tbody>
    `;

    results.forEach(
      result => {
        html += `
        <tr>
          <td><code>${result.center_name}</code></td>
          <td>${result.instructor_name}</td>
          <td>${result.education_name}</td>
          <td><strong>${result.survey_cnt}</strong></td>
          <td><strong>${result.avg_score}</strong></td>
          <td><strong>${result.avg_inst_score}</strong></td>
          <td><button class="btn" onclick="showResultDetail('${result.unique_key}')" style="padding: 5px 10px; font-size: 0.8rem;">ë³´ê¸°</button></td>
        </tr>
        `;
      }
    );

    html += '</tbody></table>';
    surveyResultsDiv.innerHTML = html;
}

// ì‘ë‹µ ìƒì„¸ ë‚´ì—­ í‘œì‹œ í•¨ìˆ˜
async function showResultDetail(uniqueKey) {
    if (!supabase) {
        showAlert('ë¨¼ì € Supabaseì— ì—°ê²°í•´ì£¼ì„¸ìš”.', 'error');
        return;
    }

    // ì‘ë‹µë‚´ì—­ íƒ­ìœ¼ë¡œ ì´ë™
    showPage('survey');
    
    const surveyDetailDiv = document.getElementById('survey');
    surveyDetailDiv.innerHTML = `
        <div class="loading">
            <div class="spinner"></div>
            <p>ì‘ë‹µ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
    `;

    try {
        // unique_keyë¡œ survey_results í…Œì´ë¸”ì—ì„œ ëª¨ë“  ì‘ë‹µ ì¡°íšŒ
        const { data, error } = await supabase
            .from('survey_results')
            .select('*')
            .eq('unique_key', uniqueKey)
            .order('submitted_at', { ascending: false });

        if (error) throw error;

        displayDetailedResults(data, uniqueKey);

    } catch (error) {
        surveyDetailDiv.innerHTML = `
            <div class="alert alert-error">
                ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: ${error.message}
            </div>
        `;
    }
}

// ìƒì„¸ ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜
function displayDetailedResults(results, uniqueKey) {
    const surveyDetailDiv = document.getElementById('survey');
    
    if (results.length === 0) {
        surveyDetailDiv.innerHTML = `
            <div class="alert alert-info">
                <h3>ì‘ë‹µ ë‚´ì—­</h3>
                <p>ê³ ìœ í‚¤ "${uniqueKey}"ì— ëŒ€í•œ ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
        `;
        return;
    }

    // êµìœ¡ ì •ë³´ (ì²« ë²ˆì§¸ ì‘ë‹µì—ì„œ ì¶”ì¶œ)
    const educationInfo = results[0];
    
    // í†µê³„ ê³„ì‚°
    const totalResponses = results.length;
    let totalScore = 0;
    let totalInstScore = 0;
    results.forEach(result => {
        totalScore += (result.q1_rating + result.q2_rating + result.q3_rating + result.q4_rating + result.q5_rating + result.q6_rating + result.q7_rating + result.q8_rating + result.q9_rating + result.q10_rating) / 10;
        totalInstScore += (result.q5_rating + result.q6_rating + result.q7_rating + result.q8_rating) / 4;
    });
    const avgScore = (totalScore / totalResponses).toFixed(1);
    const instScore = (totalInstScore / totalResponses).toFixed(1);

    let html = `
        <div style="margin-bottom: 20px;">
            <h2>ğŸ“ ì‘ë‹µ ìƒì„¸ ë‚´ì—­</h2>
            <div class="alert alert-info">
              <table width="100%%">
                <tr>
                  <td width="50%"><strong>ì„¤ë¬¸ ê³ ìœ í‚¤:</strong> ${uniqueKey}</td>
                  <td width="50%"><strong>ì´ ì‘ë‹µ ìˆ˜:</strong> ${totalResponses}ê±´</td>
                </tr>
                <tr>
                 <td><strong>ì„¼í„°ëª…:</strong> ${educationInfo.center_name} </td>
                 <td><strong>í‰ê·  ë§Œì¡±ë„:</strong> ${avgScore}ì  </td>
                 </tr>
                <tr>
                  <td><strong>ê°•ì‚¬ëª…:</strong> ${educationInfo.instructor_name} </td>
                  <td><strong>ê°•ì‚¬ ë§Œì¡±ë„:</strong> ${instScore}ì  </td>
                </tr>
                <tr>
                  <td><strong>êµìœ¡ëª…:</strong> ${educationInfo.education_name}</td>
                  <td><strong> </td>
                </tr>
              </table>
            </div>
        </div>

        <div class="scrollable-list">
            <table class="table">
                <thead>
                    <tr>
                        <th width="12%">ì‘ë‹µì¼</th>
                        <th width="10%">ì‘ë‹µì</th>
                        <th width="6%">ì„±ë³„</th>
                        <th width="7%">ì—°ë ¹ëŒ€</th>
                        <th width="4%">Q1</th>
                        <th width="4%">Q2</th>
                        <th width="4%">Q3</th>
                        <th width="4%">Q4</th>
                        <th width="4%">Q5</th>
                        <th width="4%">Q6</th>
                        <th width="4%">Q7</th>
                        <th width="4%">Q8</th>
                        <th width="4%">Q9</th>
                        <th width="4%">Q10</th>
                        <th width="6%">í‰ê· </th>
                        <th width="6%">ê°•ì‚¬</th>
                        <th width="13%">ì˜ê²¬</th>
                    </tr>
                </thead>
                <tbody>
    `;

    results.forEach(result => {
        const avgScore = ((result.q1_rating + result.q2_rating + result.q3_rating + result.q4_rating + result.q5_rating +
            result.q6_rating + result.q7_rating + result.q8_rating + result.q9_rating + result.q10_rating) / 10).toFixed(1);
        const instScore = ((result.q5_rating + result.q6_rating + result.q7_rating + result.q8_rating) / 4).toFixed(1);
        
        const submittedDate = new Date(result.submitted_at).toLocaleDateString('ko-KR', {
            year: '2-digit',
            month: '2-digit',
            day: '2-digit'
        });

        html += `
            <tr>
                <td><code>${submittedDate}</code></td>
                <td><code>${result.respondent_name}</code></td>
                <td>${result.gender}</td>
                <td>${result.age_group}</td>
                <td>${result.q1_rating}</td>
                <td>${result.q2_rating}</td>
                <td>${result.q3_rating}</td>
                <td>${result.q4_rating}</td>
                <td>${result.q5_rating}</td>
                <td>${result.q6_rating}</td>
                <td>${result.q7_rating}</td>
                <td>${result.q8_rating}</td>
                <td>${result.q9_rating}</td>
                <td>${result.q10_rating}</td>
                <td><strong>${avgScore}</strong></td>
                <td>${instScore}</td>
                <td style="font-size: 0.8em;">${result.additional_comments || '-'}</td>
            </tr>
        `;
    });

    html += `
                </tbody>
            </table>
        </div>

        <div style="text-align: right">
          <br />
          <button class="btn" onclick="downloadXLSData('${educationInfo.center_name}', { unique_key: '${uniqueKey}'})">
            ì‘ë‹µ xls ë‹¤ìš´ë¡œë“œ
          </button>
          <button class="btn btn-secondary" onclick="downloadXLSData('${educationInfo.center_name}', { unique_key: '${uniqueKey}'})">
            ${educationInfo.center_name} ì „ì²´ xls ë‹¤ìš´ë¡œë“œ
          </button>
        </div>
      `;

    surveyDetailDiv.innerHTML = html;
}

// í•„í„°ë§ëœ ë°ì´í„° ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
// downloadFilteredDataAsXLS('ì„¼í„°ëª…', { instructer_name: 'ì•„ë¬´ê°œ', agegroup: '10ëŒ€' })
async function downloadXLSData(center_name, filters = {}) {
    try {
        const ResultAlertDiv = document.getElementById("ResultAlertDiv");
        let query = supabase.from('survey_results').select('*');
        if (center_name) {
            query = query.ilike('center_name', `%${center_name}%`);
        }
        // í•„í„° ì ìš©
        Object.entries(filters).forEach(([column, value]) => {
            query = query.eq(column, value)
        })

        const { data, error } = await query
        if (error) {
          ResultAlertDiv.innerHTML = `<div class="alert alert-error">ë°ì´í„° ì¡°íšŒ ì˜¤ë¥˜: ${error.message}</div>`;
          return
        }
        if (!data || data.length === 0) {
          ResultAlertDiv.innerHTML = `<div class="alert alert-error">ì¡°ê±´ì— ë§ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤: ${error.message}</div>`;
          return
        }
        
        const workbook = XLSX.utils.book_new()
        const worksheet = XLSX.utils.json_to_sheet(data)
        XLSX.utils.book_append_sheet(workbook, worksheet, center_name)
        
        const downloadFileName = `${center_name}_ì„¤ë¬¸ì‘ë‹µ_${new Date().toISOString().split('T')[0]}.xlsx`
        XLSX.writeFile(workbook, downloadFileName)
        
    } catch (error) {
      ResultAlertDiv.innerHTML = `<div class="alert alert-error">ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜: ${error.message}</div>`;
    }
}

    </script>
  </body>
</html>
