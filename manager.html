<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>KCMF 강의평가 설문관리</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Arial", sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1000px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(45deg, #4f46e5, #7c3aed);
        color: white;
        padding: 30px;
        text-align: center;
        position: relative;
      }
      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        font-weight: bold;
      }
      .header p {
        font-size: 1.1rem;
        opacity: 0.9;
      }

      .nav-tabs {
        display: flex;
        background: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
      }
      .nav-tab {
        flex: 1;
        padding: 15px 20px;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1rem;
        transition: all 0.3s ease;
        color: #64748b;
      }
      .nav-tab.active {
        background: white;
        color: #4f46e5;
        border-bottom: 3px solid #4f46e5;
        font-weight: bold;
      }
      .nav-tab:hover {
        background: #e2e8f0;
      }

      .content {
        padding: 30px;
        min-height: 400px;
      }

      .page {
        display: none;
      }

      .page.active {
        display: block;
        animation: fadeIn 0.5s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .form-group {
        margin-bottom: 20px;
      }
      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        color: #374151;
      }
      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s ease;
      }
      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #4f46e5;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
      }

      .btn {
        background: linear-gradient(45deg, #4f46e5, #7c3aed);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-right: 10px;
        margin-bottom: 10px;
      }
      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(79, 70, 229, 0.3);
      }
      .btn-secondary {
        background: #6b7280;
      }
      .btn-danger {
        background: #dc2626;
      }

      .table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      .table th,
      .table td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid #e5e7eb;
      }
      .table th {
        background: #f8fafc;
        font-weight: bold;
        color: #374151;
      }
      .table tr:hover {
        background: #f8fafc;
      }

      .config-section {
        background: #f8fafc;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
      }
      .config-section h3 {
        color: #4f46e5;
        margin-bottom: 15px;
      }
      .config-section input,
      .config-section select,
      .config-section textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s ease;
      }

      .alert {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
      }
      .alert-success {
        background: #d1fae5;
        color: #065f46;
      }
      .alert-error {
        background: #fee2e2;
        color: #991b1b;
      }
      .alert-info {
        background: #dbeafe;
        color: #1e40af;
      }

      .loading {
        display: none;
        text-align: center;
        padding: 20px;
      }

      .spinner {
        border: 4px solid #e5e7eb;
        border-top: 4px solid #4f46e5;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }
      .stat-card {
        background: linear-gradient(45deg, #4f46e5, #7c3aed);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
      }
      .stat-number {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
      }
      .modal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 30px;
        border-radius: 15px;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
      }

      .close {
        float: right;
        font-size: 24px;
        cursor: pointer;
        color: #6b7280;
      }
      .close:hover {
        color: #374151;
      }

      /* 스크롤 가능한 리스트 컨테이너 스타일 */
      .scrollable-list {
        max-height: 600px;
        overflow-y: auto;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>🎯 KCMF 강의평가 관리</h1>
        <p>시청자미디어재단 직원용 시스템</p>
      </div>

      <div class="nav-tabs">
        <button
          class="nav-tab active"
          data-page="config"
          onclick="showPage('config')"
        >
          🔧로그인
        </button>
        <button class="nav-tab" data-page="admin1" onclick="showPage('admin1')">
          📋교육 관리
        </button>
        <button class="nav-tab" data-page="admin2" onclick="showPage('admin2')">
          📊설문 현황
        </button>
        <button class="nav-tab" data-page="survey" onclick="showPage('survey')">
          📝응답 내역
        </button>
      </div>

      <div class="content">
        <!-- DB 설정 페이지 -->
        <div id="config" class="page active">
          <div class="config-section">
            <h3>로그인</h3>
            <div id="loginform" class="form-group">
              <input type="email" id="login_email" placeholder="이메일" />
              <input
                type="password"
                id="login_password"
                placeholder="비밀번호"
              />
              <button id="login_btn" class="btn" onclick="signIn()">
                로그인
              </button>
              <button
                id="logout_btn"
                class="btn btn-secondary"
                onclick="signOut()"
              >
                로그아웃
              </button>
            </div>
            <div id="authStatus" class="alert alert-info"></div>
          </div>

          <div class="config-section">
            <h3>설명</h3>
            <textarea rows="6">
=== 사용방법 (직원용) ===

1. 설문 페이지는 누구나 접근 가능. 보안 없음.
   관리 페이지는 로그인 계정이 필요함. 계정 발급은 DB설치 관리자에게 문의. 

2. 교육 관리 탭:
  - 설문은 센터명+강사명+교육명 조합에 따라 각 교육별로 설문이 생성됨
  - 수강생에게 안내할 설문 페이지 주소는 survey.html 뒤에 #s=고유키 를 붙이면 됨. (고유키를 사용하는 이유는 아무 번호나 입력해서 다른 사람의 설문에 접근하는 것을 막기 위해서임.) 
  - 설문 페이지에 가서 QR코드를 확인할 수 있음.
  - 설문 가능한 기간은 기본값으로 생성일로부터 1개월간임. 설문기간 이외에는 응답할 수 없음. (역시 보안을 위해 필요함.)
  - 직원 계정은 자신이 만든 교육만 수정하거나 삭제할 수 있으며, 다른 직원 계정의 데이터를 건드릴 수 없음. 
  - 교육과정을 수정하더라도 이미 진행된 설문내용은 바뀌지 않음. (센터명, 강사명, 교육명이 달라도 동일한 고유키를 가진 설문응답이 존재할 수 있음.)

3. 설문 현황 탭:
  - 수강생들이 작성한 설문응답의 목록과 통계를 볼 수 있음.
  - 검색을 하면 검색조건에 따른 결과만 가지고 통계와 목록을 보여줌.
  - 상세 버튼을 누르면 응답 내역 탭으로 이동하게 됨.

4. 응답 내역 탭:
  - 설문 현황 탭에서 선택한 1개 설문(교육프로그램)에 대해서 설문응답을 모두 보여줌.
  - 하단의 다운로드 버튼은 XLS 파일을 다운로드받게 함. 
    편의를 위해 현재 화면의 데이터 이외에 해당 센터의 응답 데이터를 한꺼번에 다운로드 받음.

=== 최초 설치 방법 (시스템 관리자용) ===

0. 본 프로그램은 php, jsp, python 과 같은 Server Side Program 이 없으며, HTML + Javascript 로만 작성되어 아무 웹서버에서나 작동함. 로컬 pc 내에서도 작동함. 단 인터넷은 연결되어 있어야 함.
1. supabase에서 기압하고 anon key를 발급받음. 
2. 발급받은 키를 소스코드에 입력 (기존 키 수정)
3. supabase에서 Authentication 메뉴에서 Users 생성 (직원용 계정)
4. supabase에서 아래와 같이 테이블 생성하고 권한 설정 

-- 교육 정보 테이블
CREATE TABLE IF NOT EXISTS education_info (
id SERIAL PRIMARY KEY,
unique_key VARCHAR(50) UNIQUE NOT NULL,
user_id UUID,
center_name VARCHAR(100) NOT NULL,
instructor_name VARCHAR(100) NOT NULL,
education_name VARCHAR(200) NOT NULL,
start_date DATE,
end_date DATE,
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 설문 결과 테이블
CREATE TABLE IF NOT EXISTS survey_results (
id SERIAL PRIMARY KEY,
submitted_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
unique_key VARCHAR(50) REFERENCES education_info(unique_key),
instructor_name VARCHAR(10),
education_name VARCHAR(200),
center_name VARCHAR(10),
respondent_name VARCHAR(20),
gender VARCHAR(4),
age_group VARCHAR(10),
q1_rating INTEGER CHECK (q1_rating >= 1 AND q1_rating <= 5),
q2_rating INTEGER CHECK (q2_rating >= 1 AND q2_rating <= 5),
q3_rating INTEGER CHECK (q3_rating >= 1 AND q3_rating <= 5),
q4_rating INTEGER CHECK (q4_rating >= 1 AND q4_rating <= 5),
q5_rating INTEGER CHECK (q5_rating >= 1 AND q5_rating <= 5),
q6_rating INTEGER CHECK (q6_rating >= 1 AND q6_rating <= 5),
q7_rating INTEGER CHECK (q7_rating >= 1 AND q7_rating <= 5),
q8_rating INTEGER CHECK (q8_rating >= 1 AND q8_rating <= 5),
q9_rating INTEGER CHECK (q9_rating >= 1 AND q9_rating <= 5),
q10_rating INTEGER CHECK (q10_rating >= 1 AND q10_rating <= 5),
additional_comments TEXT,
);

-- RLS(Row Level Security) 정책 설정 
ALTER TABLE education_info ENABLE ROW LEVEL SECURITY;
ALTER TABLE survey_results ENABLE ROW LEVEL SECURITY;
-- 사용자 권한 설정
CREATE POLICY "모두 읽기 가능" ON education_info FOR SELECT USING (true);
CREATE POLICY "인증사용자는 데이터 추가 가능" ON education_info FOR INSERT WITH CHECK ( auth.uid() IS NOT NULL );
CREATE POLICY "인증사용자는 자기 데이터만 수정 가능" ON education_info FOR UPDATE USING ( auth.uid() IN (전체관리자ID) OR user_id = auth.uid() );
CREATE POLICY "인증사용자는 자기 데이터만 삭제 가능" ON education_info FOR DELETE USING ( auth.uid() IN (전체관리자ID) OR user_id = auth.uid() );
CREATE POLICY "모두 추가 가능" ON survey_results FOR INSERT WITH CHECK (true);
CREATE POLICY "인증사용자는 전체 데이터 수정 가능" ON survey_results FOR ALL USING ( auth.uid() is not null) with check (auth.uid() is not null);

-- 전체 통계 함수
CREATE OR REPLACE FUNCTION get_survey_stats(
  center_filter TEXT DEFAULT NULL,
  instructor_filter TEXT DEFAULT NULL,
  education_filter TEXT DEFAULT NULL
)
RETURNS TABLE(
  total_responses BIGINT,
  avg_rating NUMERIC(3,1),
  instructor_rating NUMERIC(3,1),
  unique_educations BIGINT
) 
LANGUAGE plpgsql
AS $$
BEGIN
  RETURN QUERY
  WITH filtered_results AS (
    SELECT 
      unique_key, center_name, instructor_name, education_name,
      q1_rating, q2_rating, q3_rating, q4_rating, q5_rating,
      q6_rating, q7_rating, q8_rating, q9_rating, q10_rating
    FROM survey_results
    WHERE 
      (center_filter IS NULL OR center_name ILIKE '%' || center_filter || '%')
      AND (instructor_filter IS NULL OR instructor_name ILIKE '%' || instructor_filter || '%')
      AND (education_filter IS NULL OR education_name ILIKE '%' || education_filter || '%')
  ),
  stats AS (
    SELECT 
      COUNT(*) as total_count,
      AVG((q1_rating + q2_rating + q3_rating + q4_rating + q5_rating + 
           q6_rating + q7_rating + q8_rating + q9_rating + q10_rating) / 10.0) as average_rating,
      AVG((q5_rating + q6_rating + q7_rating + q8_rating) / 4.0) as instructor_rating
    FROM filtered_results
  ),
  unique_count AS (
    SELECT COUNT(DISTINCT unique_key) as unique_edu_count
    FROM filtered_results
  )
  SELECT 
    stats.total_count,
    ROUND(stats.average_rating, 1),
    ROUND(stats.instructor_rating, 1),
    unique_count.unique_edu_count
  FROM stats, unique_count;
END;
$$;

-- 교육별 통계를 위한 뷰
CREATE VIEW edu_survey_view AS
SELECT 
    ei.id,
    ei.unique_key,
    ei.center_name,
    ei.instructor_name,
    ei.education_name,
    COALESCE(sr.survey_cnt, 0) as survey_cnt,
    COALESCE(sr.avg_score, 0.0) as avg_score,
    COALESCE(sr.avg_inst_score, 0.0) as avg_inst_score
FROM education_info ei
LEFT JOIN (
    SELECT 
        unique_key,
        COUNT(*) as survey_cnt,
        ROUND(
            AVG(
                (q1_rating + q2_rating + q3_rating + q4_rating + q5_rating + 
                 q6_rating + q7_rating + q8_rating + q9_rating + q10_rating) / 10.0
            ), 1
        ) as avg_score,
        ROUND(
            AVG(
                (q5_rating + q6_rating + q7_rating + q8_rating) / 4.0
            ), 1
        ) as avg_inst_score
    FROM survey_results 
    GROUP BY unique_key
) sr ON ei.unique_key = sr.unique_key;

-- VIEW 조회 권한 부여
GRANT SELECT ON edu_survey_view TO anon, authenticated;

5. 설치 후 이 화면 아래의 '연결 테스트' 버튼을 눌러 DB 접속이 되는지 확인할 수 있음.
    </textarea>
            <button class="btn" onclick="testConnection()">연결 테스트</button>
            <div id="connectionStatus"></div>
          </div>
        </div>

        <!-- 관리자 화면1: 교육 관리 -->
        <div id="admin1" class="page">
          <h2>📋 교육 검색</h2>
          <div id="education-search-ui"></div>
          <div style="text-align: right">
            <button class="btn" onclick="openEducationModal('add')">
              신규 등록
            </button>
          </div>

          <div
            id="educationCount"
            style="margin-bottom: 10px; font-weight: bold"
          ></div>
          <div id="educationList" class="scrollable-list">
            <div class="loading">
              <div class="spinner"></div>
              <p>데이터를 불러오는 중...</p>
            </div>
          </div>
        </div>

        <!-- 관리자 화면2: 설문 현황 -->
        <div id="admin2" class="page">
          <h2>📊 설문 검색</h2>
          <div id="survey-search-ui"></div>

          <h2>📊 검색 결과</h2>
          <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
              <div class="stat-number" id="uniqueEducations">0</div>
              <div>교육 과정</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="totalResponses">0</div>
              <div>총 응답 수</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="avgRating">0.0</div>
              <div>평균 만족도</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="instructorRating">0.0</div>
              <div>강사 만족도</div>
            </div>
          </div>

          <div id="surveyResults" class="scrollable-list">
            <div class="loading">
              <div class="spinner"></div>
              <p>설문 결과를 불러오는 중...</p>
            </div>
          </div>
        </div>

        <!-- 관리자 화면3: 응답 내역 -->
        <div id="survey" class="page">

          <div id="surveyDetailDiv"></div>
          <div id="ResultAlertDiv"></div>

        </div>
      </div>
    </div>

    <!-- 교육정보 모달 -->
    <div id="educationModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeEducationModal()">&times;</span>
        <h3 id="modalTitle">교육 정보</h3>
        <div class="form-group">
          <label>센터명:</label>
          <select id="modalCenter">
            <option value="부산센터">부산센터</option>
            <option value="경남센터">경남센터</option>
            <option value="울산센터">울산센터</option>
          </select>
        </div>
        <div class="form-group">
          <label>강사명:</label>
          <input type="text" id="modalInstructor" />
        </div>
        <div class="form-group">
          <label>교육명:</label>
          <input type="text" id="modalEducation" />
        </div>
        <div class="form-group">
          <label>설문기간:</label>
          <input type="text" id="modalStartDate" /> ~
          <input type="text" id="modalEndDate" />
        </div>
        <div style="margin-top: 20px">
          <button
            class="btn"
            id="modalActionButton"
            onclick="handleEducationAction()"
          >
            등록
          </button>
          <button class="btn btn-secondary" onclick="closeEducationModal()">
            취소
          </button>
        </div>
      </div>
    </div>

    <script>
// 설문파일 위치
// var survey_url = 'https://kcmf.or.kr/survey.html';
var survey_url = String(window.location.href).replace('/manager.html', '/survey.html');

// DB 접속 및 생성
var supabase = supabase.createClient('https://fnxmyayfosjwuvsxbabm.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZueG15YXlmb3Nqd3V2c3hiYWJtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk2MTg2NzcsImV4cCI6MjA2NTE5NDY3N30.rAldXcD4_tsstfd9xHzKw3QgIHBrHvaFkBv6TJRVhjA')

// Supabase 연결 테스트
async function testConnection() {
    try {
        const { data, error } = await supabase.from('education_info').select('count').limit(1);
        if (error) throw error;
        showAlert('데이터베이스 연결 테스트 성공!', 'success');
    } catch (error) {
        showAlert('데이터베이스 테스트 실패: ' + error.message, 'error');
    }
}

// 알림 표시
function showAlert(message, type) {
    const statusDiv = document.getElementById('connectionStatus');
    statusDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
    setTimeout(() => {
        statusDiv.innerHTML = '';
    }, 5000);
}

// 로그인 상태에 따라 로그인 활성화/비활성화
function updateLoginUI(isLoggedIn = false) {
    const emailInput = document.getElementById('login_email');
    const passwordInput = document.getElementById('login_password');
    const loginBtn = document.getElementById('login_btn');
    const logoutBtn = document.getElementById('logout_btn');
    if (isLoggedIn) {
        emailInput.readOnly = true;
        emailInput.style.backgroundColor = '#ddd';
        passwordInput.readOnly = true;
        passwordInput.style.backgroundColor = '#ddd';
        loginBtn.className = 'btn btn-secondary';
        logoutBtn.className = 'btn';
    } else {
        emailInput.readOnly = false;
        emailInput.style.backgroundColor = 'white';
        passwordInput.value = '';
        passwordInput.readOnly = false;
        passwordInput.style.backgroundColor = 'white';
        loginBtn.className = 'btn';
        logoutBtn.className = 'btn btn-secondary';
    }
}


// 로그인 함수
async function signIn() {
    const email = document.getElementById('login_email').value;
    const password = document.getElementById('login_password').value;
    const { data, error } = await supabase.auth.signInWithPassword({
        email: email,
        password: password
    });

    if (error) {
        document.getElementById('authStatus').innerText = '로그인 실패: ' + error.message;
    } else {
        document.getElementById('authStatus').innerText = '로그인 성공! 사용자 ID: ' + data.user.id;
        updateLoginUI(true);
        showPage('admin1');
    }
}

// 로그아웃 함수
async function signOut() {
    const { error } = await supabase.auth.signOut();
    if (error) {
        document.getElementById('authStatus').innerText = '로그아웃 실패: ' + error.message;
    } else {
        document.getElementById('authStatus').innerText = '로그아웃 되었습니다.';
        updateLoginUI(false);
    }
}

// 로그인 상태 변화 감지
supabase.auth.onAuthStateChange(async (event, session) => {
    if (session && session.user) {
        document.getElementById('authStatus').innerText = `로그인 상태: ${session.user.id}`;
        updateLoginUI(true);
        showPage('admin1');
    } else {
        document.getElementById('authStatus').innerText = '로그인 상태: 로그아웃됨';
        updateLoginUI(false);
        showPage('config');
    }
});

// 페이지 전환
async function showPage(pageId) {

    // 로그인 상태 확인 (로그인 안했으면 설정 화면으로 이동)
    const { data: { session } } = await supabase.auth.getSession();
    if (!session || !session.user) pageId = "config";

    // 모든 페이지 숨기기
    document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
    });

    // 모든 탭 비활성화
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
    });

    // 선택된 페이지 표시
    document.getElementById(pageId).classList.add('active');
    const activeTab = document.querySelector(`.nav-tab[data-page="${pageId}"]`);
    if (activeTab) activeTab.classList.add('active');

    // 페이지별 초기 화면 로딩 (최초 진입 시애만)
    if (pageId === 'admin1') {
      const searchUI = document.getElementById('education-search-ui');
      if (!searchUI.hasChildNodes()) {
        educationPage = 0;
        currentEducations = [];
        // 기존 스크롤 리스너 제거 (중복 방지)
        const listDiv = document.getElementById('educationList');
        if (listDiv && listDiv.hasScrollListener) {
            listDiv.removeEventListener('scroll', handleEducationScroll);
            listDiv.hasScrollListener = false;
        }
        // 검색 인터페이스 생성
        createSearchInterface(
            'education-search-ui',
            (filters) => { // 검색 콜백
                educationPage = 0;
                currentEducations = [];
                loadEducations(filters);
            },
            () => { // 초기화 콜백
                educationPage = 0;
                currentEducations = [];
                loadEducations();
            }
          );
          loadEducations();
      }
    } else if (pageId === 'admin2') {
      // 검색 인터페이스가 없을 때만 생성 (최초 진입)
      const searchUI = document.getElementById('survey-search-ui');
      if (!searchUI.hasChildNodes()) {
        surveyPage = 0;
        currentSurveyResults = [];
        // 기존 스크롤 리스너 제거 (중복 방지)
        const surveyDiv = document.getElementById('surveyResults');
        if (surveyDiv && surveyDiv.hasScrollListener) {
            surveyDiv.removeEventListener('scroll', handleSurveyScroll);
            surveyDiv.hasScrollListener = false;
        }
        // 검색 인터페이스 생성
        createSearchInterface(
            'survey-search-ui',
            (filters) => { // 검색 콜백
                surveyPage = 0;
                currentSurveyResults = [];
                loadSurveyResults(filters);
            },
            () => { // 초기화 콜백
                surveyPage = 0;
                currentSurveyResults = [];
                loadSurveyResults();
            }
        );
        loadSurveyResults();
      }
    } else {
        // 다른 페이지로 이동할 때 상태 정리
        const listDiv = document.getElementById('educationList');
        if (listDiv && listDiv.hasScrollListener) {
            listDiv.removeEventListener('scroll', handleEducationScroll);
            listDiv.hasScrollListener = false;
        }
        const surveyDiv = document.getElementById('surveyResults');
        if (surveyDiv && surveyDiv.hasScrollListener) {
            surveyDiv.removeEventListener('scroll', handleSurveyScroll);
            surveyDiv.hasScrollListener = false;
        }
        window.isLoadingEducations = false;
        window.isLoadingSurveys = false;
    }
}

function generateUniqueKey(center, instructor) {
    // 문자열 길이 기반 간단한 해시 (각 문자의 코드값 합산)
    let hash = center.length + instructor.length;
    for (let i = 0; i < center.length; i++) {
        hash += center.charCodeAt(i);
    }
    for (let i = 0; i < instructor.length; i++) {
        hash += instructor.charCodeAt(i);
    }
    // 36진법으로 변환하여 짧게 만들기
    const hashStr = (hash % 1679616).toString(36); // 1679616 = 36^4, 최대 4자리
    // 현재 시간에서 2000년을 빼버리면 남은 숫자가 줄어든다
    const now = Date.now();
    const year2000 = new Date('2000-01-01').getTime();
    const timeStr = (now - year2000).toString(36);
    return `${hashStr}${timeStr}`;
}

let editingEducationId = null; // 수정 모드일 때만 사용
let modalMode = 'add'; // 교육 추가 수정 시 'add' 또는 'edit' 모드

const recordsPerPage = 50; // 페이지당 레코드 수

// 교육 관리 관련 전역 변수
let educationPage = 0; 
let educationIsLoading = false;
let educationHasMore = true;
let currentEducations = [];

// 설문 현황 관련 전역 변수
let surveyPage = 0;
let surveyIsLoading = false;
let surveyHasMore = true;
let currentSurveyResults = [];

/**
 * 재사용 가능한 검색 UI를 생성하고 이벤트 리스너를 연결합니다.
 * @param {string} containerId - 검색 UI가 삽입될 div의 ID
 * @param {function} onSearch - '검색' 버튼 클릭 시 실행될 콜백 함수
 * @param {function} onReset - '초기화' 버튼 클릭 시 실행될 콜백 함수
 */
function createSearchInterface(containerId, onSearch, onReset) {
    const container = document.getElementById(containerId);
    if (!container) return;

    // 검색 UI의 HTML 구조
    container.innerHTML = `
    <div class="form-group" style="margin-top: 20px; margin-bottom: 20px; padding: 20px; background: #f8fafc; border-radius: 8px;">
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
        <div class="form-group">
          <label>센터명:</label>
          <!--<input type="text" class="search-center" placeholder="센터명 입력">-->
          <select class="search-center">
            <option value="">--전체--</option>
            <option value="부산센터">부산센터</option>
            <option value="경남센터">경남센터</option>
            <option value="울산센터">울산센터</option>
          </select>
        </div>
        <div class="form-group">
          <label>강사명:</label>
          <input type="text" class="search-instructor" placeholder="강사명 입력">
        </div>
        <div class="form-group">
          <label>교육명:</label>
          <input type="text" class="search-education" placeholder="교육명 입력">
        </div>
      </div>
      <button class="btn search-btn">검색</button>
      <button class="btn btn-secondary reset-btn">검색 초기화</button>
    </div>
    `;

    // 생성된 UI 내의 요소에 이벤트 리스너 연결
    const searchBtn = container.querySelector('.search-btn');
    const resetBtn = container.querySelector('.reset-btn');
    const centerInput = container.querySelector('.search-center');
    const instructorInput = container.querySelector('.search-instructor');
    const educationInput = container.querySelector('.search-education');

    // 검색 버튼 클릭 이벤트
    searchBtn.addEventListener('click', () => {
        const filters = {
            center: centerInput.value,
            instructor: instructorInput.value,
            education: educationInput.value,
        };
        onSearch(filters); // 전달받은 onSearch 콜백 함수 실행
    });

    // 초기화 버튼 클릭 이벤트
    resetBtn.addEventListener('click', () => {
        centerInput.value = '';
        instructorInput.value = '';
        educationInput.value = '';
        onReset(); // 전달받은 onReset 콜백 함수 실행
    });
}

// 교육 목록 로드 (검색 및 페이징 적용)
async function loadEducations(filters = {}) {
    if (educationIsLoading) return;
    educationIsLoading = true;

    if (!supabase) {
        document.getElementById('educationList').innerHTML = '<div class="alert alert-error">먼저 Supabase에 연결해주세요.</div>';
        return;
    }

    const listDiv = document.getElementById('educationList');
    const loadingDiv = listDiv.querySelector('.loading');
    if (loadingDiv) loadingDiv.style.display = 'block';

    // 검색 시 또는 첫 로드 시 currentEducations 초기화
    if (educationPage === 0) {
        currentEducations = [];
        listDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>데이터를 불러오는 중...</p></div>';
    }

    // 이미 로딩 중인지 확인하여 중복 요청 방지
    if (window.isLoadingEducations) {
        return;
    }
    window.isLoadingEducations = true;

    let query = supabase.from('education_info').select('*', { count: 'exact' });

    // 검색 조건 추가
    if (filters.center) {
        query = query.ilike('center_name', `%${filters.center}%`);
    }
    if (filters.instructor) {
        query = query.ilike('instructor_name', `%${filters.instructor}%`);
    }
    if (filters.education) {
        query = query.ilike('education_name', `%${filters.education}%`);
    }

    // 페이징 적용
    const from = educationPage * recordsPerPage;
    const to = from + recordsPerPage - 1;
    query = query.order('created_at', { ascending: false }).range(from, to);

    try {
        const { data, error, count } = await query;
        if (error) throw error;

        currentEducations = currentEducations.concat(data); // 새로 불러온 데이터를 기존 데이터에 추가

        displayEducations(currentEducations, count, educationPage === 0); // isInitialRender 플래그 추가

        if (loadingDiv) loadingDiv.style.display = 'none';

        // 스크롤 로드를 위한 이벤트 리스너 추가 (최초 로드 시에만)
        if (!listDiv.hasScrollListener) {
            listDiv.addEventListener('scroll', handleEducationScroll);
            listDiv.hasScrollListener = true;
        }
        window.isLoadingEducations = false; // 로딩 상태 해제

    } catch (error) {
        document.getElementById('educationList').innerHTML = `<div class="alert alert-error">로딩 실패: ${error.message}</div>`;
        if (loadingDiv) loadingDiv.style.display = 'none';

    } finally {
        educationIsLoading = false;
    }
}

// 교육 목록 표시 (검색 건수 업데이트 포함)
function displayEducations(educations, totalCount, isInitialRender = false) {
    const listDiv = document.getElementById('educationList');
    const educationCountDiv = document.getElementById('educationCount');

    educationCountDiv.textContent = `총 ${totalCount}건의 교육 과정이 검색되었습니다.`;

    if (educations.length === 0) {
        listDiv.innerHTML = '<div class="alert alert-info">등록된 교육 과정이 없습니다.</div>';
        return;
    }

    let html = `
    <table class="table">
    <thead>
    <tr>
    <th width="12%">센터</th>
    <th width="11%">강사명</th>
    <th width="28%">교육명</th>
    <th width="14%">설문기간</th>
    <th width="17%">설문 URL<br/>(고유키)</th>
    <th width="18%">작업</th>
    </tr>
    </thead>
    <tbody>
    `;

    educations.forEach(edu => {
        html += `
    <tr>
    <td><code>${edu.center_name}</code></td>
    <td>${edu.instructor_name}</td>
    <td>${edu.education_name}</td>
    <td><code>${edu.start_date}<br/>~${edu.end_date}</code></td>
    <td><a href="${survey_url}#s=${edu.unique_key}" target="_blank" style="color: #4f46e5;">${edu.unique_key}</a></td>
    <td>
    <button class="btn" onclick="openEducationModal('edit', ${edu.id})" style="padding: 5px 10px; font-size: 0.8rem;">수정</button>
    <button class="btn btn-danger" onclick="deleteEducation(${edu.id},'${edu.unique_key}')" style="padding: 5px 10px; font-size: 0.8rem;">삭제</button>
    </td>
    </tr>
    `;
    });

    html += '</tbody></table>';
    listDiv.innerHTML = html;
}

// 교육 스크롤 이벤트 핸들러
function handleEducationScroll() {
    const listDiv = document.getElementById('educationList');
    // 이미 로딩 중이면 중복 실행 방지
    if (window.isLoadingEducations) return;
    // 스크롤이 끝에서 50px 정도까지 가면 추가 로드
    if (listDiv.scrollTop + listDiv.clientHeight >= listDiv.scrollHeight - 50) {
        educationPage++;
        loadEducations();
    }
}

// 교육 정보 모달 열기 (추가/수정 겸용)
function openEducationModal(mode, id = null) {
    modalMode = mode;
    const modalTitle = document.getElementById('modalTitle');
    const modalActionButton = document.getElementById('modalActionButton');

    // 필드 초기화
    document.getElementById('modalCenter').selectedIndex = 0;
    document.getElementById('modalInstructor').value = '';
    document.getElementById('modalEducation').value = '';
    document.getElementById('modalStartDate').value = '';
    document.getElementById('modalEndDate').value = '';
    editingEducationId = null; // 초기화

    if (mode === 'add') {
        modalTitle.textContent = '새 교육 정보 등록';
        modalActionButton.textContent = '등록';
        modalActionButton.onclick = addEducation; // 등록 함수 연결
        // 기본값으로 오늘 날짜와 4주후 날짜를 설정 (YYYY-MM-DD)
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0'); // 월은 0부터 시작하므로 +1
        const day = String(today.getDate()).padStart(2, '0');
        document.getElementById('modalStartDate').value = `${year}-${month}-${day}`;
        const fourWeeksLater = new Date();
        fourWeeksLater.setDate(today.getDate() + 28); // 오늘 날짜에 28일 (4주) 더하기
        const endYear = fourWeeksLater.getFullYear();
        const endMonth = String(fourWeeksLater.getMonth() + 1).padStart(2, '0');
        const endDay = String(fourWeeksLater.getDate()).padStart(2, '0');
        document.getElementById('modalEndDate').value = `${endYear}-${endMonth}-${endDay}`;

    } else if (mode === 'edit') {
        modalTitle.textContent = '교육 정보 수정';
        modalActionButton.textContent = '수정';
        modalActionButton.onclick = updateEducation; // 수정 함수 연결

        const education = currentEducations.find(edu => edu.id === id);
        if (!education) {
            showAlert('수정할 교육 정보를 찾을 수 없습니다.', 'error');
            return;
        }
        editingEducationId = id;
        // document.getElementById('modalCenter').value = education.center_name;
        const modalCenter = document.getElementById('modalCenter');
        console.log(education);
        modalCenter.value = education.center_name;
        if (modalCenter.value !== education.center_name) {
            for (let i = 0; i < modalCenter.options.length; i++) {
                if (modalCenter.options[i].value === education.center_name) {
                    modalCenter.selectedIndex = i;
                    break;
                }
            }
        }
        console.log(modalCenter.value, education.center_name);
        document.getElementById('modalInstructor').value = education.instructor_name;
        document.getElementById('modalEducation').value = education.education_name;
        document.getElementById('modalStartDate').value = education.start_date;
        document.getElementById('modalEndDate').value = education.end_date;
    }
    document.getElementById('educationModal').style.display = 'block';
}

// 교육 정보 모달 닫기
function closeEducationModal() {
    document.getElementById('educationModal').style.display = 'none';
}

// 모달 액션 핸들러 (추가 또는 수정 함수를 호출)
function handleEducationAction() {
    if (modalMode === 'add') {
        addEducation();
    } else if (modalMode === 'edit') {
        updateEducation();
    }
}

// 교육 정보 추가
async function addEducation() {
    if (!supabase) {
        showAlert('먼저 Supabase에 연결해주세요.', 'error');
        return;
    }

    const instructor = document.getElementById('modalInstructor').value;
    const education = document.getElementById('modalEducation').value;
    const center = document.getElementById('modalCenter').value;
    const uniqueKey = generateUniqueKey(instructor, education, center);
    const start_date = document.getElementById('modalStartDate').value;
    const end_date = document.getElementById('modalEndDate').value;

    if (!instructor || !education || !center || !start_date || !end_date) {
        showAlert('모든 필드를 입력해주세요.', 'error');
        return;
    }

    try {
        const { data, error } = await supabase
            .from('education_info')
            .insert([{
                unique_key: uniqueKey,
                center_name: center,
                instructor_name: instructor,
                education_name: education,
                start_date: start_date,
                end_date: end_date
            }]);

        if (error) throw error;

        showAlert('교육 정보가 성공적으로 추가되었습니다!', 'success');
        closeEducationModal();
        educationPage = 0;
        currentEducations = [];
        loadEducations();
    } catch (error) {
        showAlert('추가 실패: ' + error.message, 'error');
    }
}

// 교육 정보 업데이트
// 주의: unique_key 값은 변경하지 않는다. (변경하면 기존 설문은 모두 무효가 됨.)
async function updateEducation() {
    const center = document.getElementById('modalCenter').value;
    const instructor = document.getElementById('modalInstructor').value;
    const education = document.getElementById('modalEducation').value;
    const start_date = document.getElementById('modalStartDate').value;
    const end_date = document.getElementById('modalEndDate').value;

    if (!instructor || !education || !center || !start_date || !end_date) {
        showAlert('모든 필드를 입력해주세요.', 'error');
        return;
    }

    try {
        const { data, error } = await supabase
            .from('education_info')
            .update({
                center_name: center,
                instructor_name: instructor,
                education_name: education,
                start_date: start_date,
                end_date: end_date,
            })
            .eq('id', editingEducationId);

        if (error) throw error;

        showAlert('교육 정보가 성공적으로 수정되었습니다!', 'success');
        closeEducationModal();
        educationPage = 0;
        currentEducations = [];
        loadEducations();
    } catch (error) {
        showAlert('수정 실패: ' + error.message, 'error');
    }
}

// 모달 외부 클릭시 닫기 (educationModal 하나만 처리)
window.onclick = function (event) {
    const educationModal = document.getElementById('educationModal');
    if (event.target === educationModal) {
        closeEducationModal();
    }
}

// 교육 정보 삭제
// TODO: 설문 데이터가 있으면 삭제하면 안됨.
async function deleteEducation(id, unique_key) {
    if (!confirm('정말로 이 교육 정보를 삭제하시겠습니까?')) return;

    try {
        const { data, error } = await supabase
            .from('education_info')
            .delete()
            .eq('id', id)
            .eq('unique_key', unique_key);

        if (error) throw error;

        showAlert('교육 정보가 삭제되었습니다.', 'success');
        educationPage = 0;
        currentEducations = [];
        loadEducations();
    } catch (error) {
        showAlert('삭제 실패: ' + error.message, 'error');
    }
}

// 통계 업데이트 함수(차선책: DB에서 집계 계산)
async function loadSurveyStats(filters = {}) {
    if (!supabase) return;
    try {
        // 1. 전체 응답 수와 평균 점수 계산
        let statsQuery = supabase
            .from('edu_survey_view')
             .select('*', { count: 'exact' });

        // 검색 조건 적용
        if (filters.center) {
            statsQuery = statsQuery.ilike('center_name', `%${filters.center}%`);
        }
        if (filters.instructor) {
            statsQuery = statsQuery.ilike('instructor_name', `%${filters.instructor}%`);
        }
        if (filters.education) {
            statsQuery = statsQuery.ilike('education_name', `%${filters.education}%`);
        }

        const { data: statsData, error: statsError, count: totalCount } = await statsQuery;
        if (statsError) throw statsError;

      // 통계 계산 방식 변경 (view의 집계된 데이터 사용)
        let totalResponses = 0;
        let totalAvgScore = 0;
        let totalInstScore = 0;
        
        statsData.forEach(row => {
            totalResponses += row.survey_cnt;
            totalAvgScore += row.avg_score * row.survey_cnt;
            totalInstScore += row.avg_inst_score * row.survey_cnt;
        });

        // 통계 업데이트
        document.getElementById('totalResponses').textContent = totalResponses;
        document.getElementById('avgRating').textContent = 
            totalResponses > 0 ? (totalAvgScore / totalResponses).toFixed(1) : '0.0';
        document.getElementById('instructorRating').textContent = 
            totalResponses > 0 ? (totalInstScore / totalResponses).toFixed(1) : '0.0';
        document.getElementById('uniqueEducations').textContent = statsData.length;

    } catch (error) {
        console.error('차선책 통계 로딩 실패:', error);
    }
}

// 통계 업데이트 함수 (최적화 버전 - PostgreSQL의 RPC 함수 사용)
async function loadSurveyStatsOptimized(filters = {}) {
    if (!supabase) return;
    try {
        // RPC를 사용하여 서버에서 모든 계산 수행
        const { data, error } = await supabase.rpc('get_survey_stats', {
            center_filter: filters.center || null,
            instructor_filter: filters.instructor || null,
            education_filter: filters.education || null
        });
        if (error) throw error;

        // 서버에서 계산된 결과 직접 사용
        document.getElementById('totalResponses').textContent = data[0].total_responses;
        document.getElementById('avgRating').textContent = data[0].avg_rating;
        document.getElementById('instructorRating').textContent = data[0].instructor_rating;
        document.getElementById('uniqueEducations').textContent = data[0].unique_educations;

    } catch (error) {
        console.error('최선책 통계 로딩 실패:', error);
        // RPC 함수가 없는 경우 fallback (위의 차선책 사용)
        await loadSurveyStats(filters);
    }
}

// 개선된 메인 로딩 함수
async function loadSurveyResults(filters = {}) {
    if (surveyIsLoading) return;
    surveyIsLoading = true;

    if (!supabase) {
        document.getElementById('surveyResults').innerHTML = 
            '<div class="alert alert-error">먼저 Supabase에 연결해주세요.</div>';
        return;
    }

    const surveyResultsDiv = document.getElementById('surveyResults');
    
    // 검색 시 또는 첫 로드 시 초기화
    if (surveyPage === 0) {
        currentSurveyResults = [];
        surveyResultsDiv.innerHTML = 
            '<div class="loading"><div class="spinner"></div><p>설문 결과를 불러오는 중...</p></div>';
        
        // 통계는 별도로 먼저 로드 (빠른 응답)
        loadSurveyStatsOptimized(filters);
    }

    if (window.isLoadingSurveys) return;
    window.isLoadingSurveys = true;

    try {
        
        // 뷰를 검색하는 것으로 변경
        let query = supabase.from('edu_survey_view').select('*');

        // 검색 조건 추가
        if (filters.center) {
            query = query.ilike('center_name', `%${filters.center}%`);
        }
        if (filters.instructor) {
            query = query.ilike('instructor_name', `%${filters.instructor}%`);
        }
        if (filters.education) {
            query = query.ilike('education_name', `%${filters.education}%`);
        }

        // 페이징 적용
        const from = surveyPage * recordsPerPage;
        const to = from + recordsPerPage - 1;
        query = query.order('id', { ascending: false }).range(from, to);

        const { data, error } = await query;
        if (error) throw error;

        currentSurveyResults = currentSurveyResults.concat(data);
        displaySurveyResults(currentSurveyResults, surveyPage === 0);

        // 통계는 이미 로드했으므로 스킵
        
        const loadingDiv = surveyResultsDiv.querySelector('.loading');
        if (loadingDiv) loadingDiv.style.display = 'none';

        // 스크롤 이벤트 리스너 설정
        if (!surveyResultsDiv.hasScrollListener) {
            surveyResultsDiv.addEventListener('scroll', handleSurveyScroll);
            surveyResultsDiv.hasScrollListener = true;
        }

    } catch (error) {
        surveyResultsDiv.innerHTML = 
            `<div class="alert alert-error">로딩 실패: ${error.message}</div>`;
    } finally {
        surveyIsLoading = false;
        window.isLoadingSurveys = false;
    }
}

// 설문 스크롤 이벤트 핸들러
function handleSurveyScroll() {
    const surveyDiv = document.getElementById('surveyResults');
    // 이미 로딩 중이면 중복 실행 방지
    if (window.isLoadingSurveys) return;
    // 스크롤이 끝에서 50px 정도까지 가면 추가 로드
    if (surveyDiv.scrollTop + surveyDiv.clientHeight >= surveyDiv.scrollHeight - 50) {
        surveyPage++;
        loadSurveyResults();
    }
}

// 응답 내역 표시
function displaySurveyResults(results, isInitialRender = false) {
    const surveyResultsDiv = document.getElementById('surveyResults');

    if (results.length === 0) {
        surveyResultsDiv.innerHTML = '<div class="alert alert-info">응답 내역이 없습니다.</div>';
        return;
    }

    let html = `
    <table class="table">
    <thead>
    <tr>
      <th width="12%">센터명</th>
      <th width="12%">강사명</th>
      <th width="28%">교육명</th>
      <th width="12%">응답수</th>
      <th width="12%">평균점수</th>
      <th width="12%">강사점수</th>
      <th width="12%">상세내역</th>
    </tr>
    </thead>
    <tbody>
    `;

    results.forEach(
      result => {
        html += `
        <tr>
          <td><code>${result.center_name}</code></td>
          <td>${result.instructor_name}</td>
          <td>${result.education_name}</td>
          <td><strong>${result.survey_cnt}</strong></td>
          <td><strong>${result.avg_score}</strong></td>
          <td><strong>${result.avg_inst_score}</strong></td>
          <td><button class="btn" onclick="showResultDetail('${result.unique_key}')" style="padding: 5px 10px; font-size: 0.8rem;">보기</button></td>
        </tr>
        `;
      }
    );

    html += '</tbody></table>';
    surveyResultsDiv.innerHTML = html;
}

// 응답 상세 내역 표시 함수
async function showResultDetail(uniqueKey) {
    if (!supabase) {
        showAlert('먼저 Supabase에 연결해주세요.', 'error');
        return;
    }

    // 응답내역 탭으로 이동
    showPage('survey');
    
    const surveyDetailDiv = document.getElementById('survey');
    surveyDetailDiv.innerHTML = `
        <div class="loading">
            <div class="spinner"></div>
            <p>응답 내역을 불러오는 중...</p>
        </div>
    `;

    try {
        // unique_key로 survey_results 테이블에서 모든 응답 조회
        const { data, error } = await supabase
            .from('survey_results')
            .select('*')
            .eq('unique_key', uniqueKey)
            .order('submitted_at', { ascending: false });

        if (error) throw error;

        displayDetailedResults(data, uniqueKey);

    } catch (error) {
        surveyDetailDiv.innerHTML = `
            <div class="alert alert-error">
                데이터 로딩 실패: ${error.message}
            </div>
        `;
    }
}

// 상세 결과 표시 함수
function displayDetailedResults(results, uniqueKey) {
    const surveyDetailDiv = document.getElementById('survey');
    
    if (results.length === 0) {
        surveyDetailDiv.innerHTML = `
            <div class="alert alert-info">
                <h3>응답 내역</h3>
                <p>고유키 "${uniqueKey}"에 대한 응답이 없습니다.</p>
            </div>
        `;
        return;
    }

    // 교육 정보 (첫 번째 응답에서 추출)
    const educationInfo = results[0];
    
    // 통계 계산
    const totalResponses = results.length;
    let totalScore = 0;
    let totalInstScore = 0;
    results.forEach(result => {
        totalScore += (result.q1_rating + result.q2_rating + result.q3_rating + result.q4_rating + result.q5_rating + result.q6_rating + result.q7_rating + result.q8_rating + result.q9_rating + result.q10_rating) / 10;
        totalInstScore += (result.q5_rating + result.q6_rating + result.q7_rating + result.q8_rating) / 4;
    });
    const avgScore = (totalScore / totalResponses).toFixed(1);
    const instScore = (totalInstScore / totalResponses).toFixed(1);

    let html = `
        <div style="margin-bottom: 20px;">
            <h2>📝 응답 상세 내역</h2>
            <div class="alert alert-info">
              <table width="100%%">
                <tr>
                  <td width="50%"><strong>설문 고유키:</strong> ${uniqueKey}</td>
                  <td width="50%"><strong>총 응답 수:</strong> ${totalResponses}건</td>
                </tr>
                <tr>
                 <td><strong>센터명:</strong> ${educationInfo.center_name} </td>
                 <td><strong>평균 만족도:</strong> ${avgScore}점 </td>
                 </tr>
                <tr>
                  <td><strong>강사명:</strong> ${educationInfo.instructor_name} </td>
                  <td><strong>강사 만족도:</strong> ${instScore}점 </td>
                </tr>
                <tr>
                  <td><strong>교육명:</strong> ${educationInfo.education_name}</td>
                  <td><strong> </td>
                </tr>
              </table>
            </div>
        </div>

        <div class="scrollable-list">
            <table class="table">
                <thead>
                    <tr>
                        <th width="12%">응답일</th>
                        <th width="10%">응답자</th>
                        <th width="6%">성별</th>
                        <th width="7%">연령대</th>
                        <th width="4%">Q1</th>
                        <th width="4%">Q2</th>
                        <th width="4%">Q3</th>
                        <th width="4%">Q4</th>
                        <th width="4%">Q5</th>
                        <th width="4%">Q6</th>
                        <th width="4%">Q7</th>
                        <th width="4%">Q8</th>
                        <th width="4%">Q9</th>
                        <th width="4%">Q10</th>
                        <th width="6%">평균</th>
                        <th width="6%">강사</th>
                        <th width="13%">의견</th>
                    </tr>
                </thead>
                <tbody>
    `;

    results.forEach(result => {
        const avgScore = ((result.q1_rating + result.q2_rating + result.q3_rating + result.q4_rating + result.q5_rating +
            result.q6_rating + result.q7_rating + result.q8_rating + result.q9_rating + result.q10_rating) / 10).toFixed(1);
        const instScore = ((result.q5_rating + result.q6_rating + result.q7_rating + result.q8_rating) / 4).toFixed(1);
        
        const submittedDate = new Date(result.submitted_at).toLocaleDateString('ko-KR', {
            year: '2-digit',
            month: '2-digit',
            day: '2-digit'
        });

        html += `
            <tr>
                <td><code>${submittedDate}</code></td>
                <td><code>${result.respondent_name}</code></td>
                <td>${result.gender}</td>
                <td>${result.age_group}</td>
                <td>${result.q1_rating}</td>
                <td>${result.q2_rating}</td>
                <td>${result.q3_rating}</td>
                <td>${result.q4_rating}</td>
                <td>${result.q5_rating}</td>
                <td>${result.q6_rating}</td>
                <td>${result.q7_rating}</td>
                <td>${result.q8_rating}</td>
                <td>${result.q9_rating}</td>
                <td>${result.q10_rating}</td>
                <td><strong>${avgScore}</strong></td>
                <td>${instScore}</td>
                <td style="font-size: 0.8em;">${result.additional_comments || '-'}</td>
            </tr>
        `;
    });

    html += `
                </tbody>
            </table>
        </div>

        <div style="text-align: right">
          <br />
          <button class="btn" onclick="downloadXLSData('${educationInfo.center_name}', { unique_key: '${uniqueKey}'})">
            응답 xls 다운로드
          </button>
          <button class="btn btn-secondary" onclick="downloadXLSData('${educationInfo.center_name}', { unique_key: '${uniqueKey}'})">
            ${educationInfo.center_name} 전체 xls 다운로드
          </button>
        </div>
      `;

    surveyDetailDiv.innerHTML = html;
}

// 필터링된 데이터 다운로드 함수
// downloadFilteredDataAsXLS('센터명', { instructer_name: '아무개', agegroup: '10대' })
async function downloadXLSData(center_name, filters = {}) {
    try {
        const ResultAlertDiv = document.getElementById("ResultAlertDiv");
        let query = supabase.from('survey_results').select('*');
        if (center_name) {
            query = query.ilike('center_name', `%${center_name}%`);
        }
        // 필터 적용
        Object.entries(filters).forEach(([column, value]) => {
            query = query.eq(column, value)
        })

        const { data, error } = await query
        if (error) {
          ResultAlertDiv.innerHTML = `<div class="alert alert-error">데이터 조회 오류: ${error.message}</div>`;
          return
        }
        if (!data || data.length === 0) {
          ResultAlertDiv.innerHTML = `<div class="alert alert-error">조건에 맞는 데이터가 없습니다: ${error.message}</div>`;
          return
        }
        
        const workbook = XLSX.utils.book_new()
        const worksheet = XLSX.utils.json_to_sheet(data)
        XLSX.utils.book_append_sheet(workbook, worksheet, center_name)
        
        const downloadFileName = `${center_name}_설문응답_${new Date().toISOString().split('T')[0]}.xlsx`
        XLSX.writeFile(workbook, downloadFileName)
        
    } catch (error) {
      ResultAlertDiv.innerHTML = `<div class="alert alert-error">다운로드 오류: ${error.message}</div>`;
    }
}

    </script>
  </body>
</html>
