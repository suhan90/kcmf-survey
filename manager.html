<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>KCMF ê°•ì˜í‰ê°€ ì„¤ë¬¸ê´€ë¦¬</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Arial", sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(45deg, #4f46e5, #7c3aed);
        color: white;
        padding: 30px;
        text-align: center;
        position: relative;
      }
      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        font-weight: bold;
      }
      .header p {
        font-size: 1.1rem;
        opacity: 0.9;
      }

      .nav-tabs {
        display: flex;
        background: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
      }
      .nav-tab {
        flex: 1;
        padding: 15px 20px;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1rem;
        transition: all 0.3s ease;
        color: #64748b;
      }
      .nav-tab.active {
        background: white;
        color: #4f46e5;
        border-bottom: 3px solid #4f46e5;
        font-weight: bold;
      }
      .nav-tab:hover {
        background: #e2e8f0;
      }

      .content {
        padding: 30px;
        min-height: 400px;
      }

      .page {
        display: none;
      }

      .page.active {
        display: block;
        animation: fadeIn 0.5s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .form-group {
        margin-bottom: 20px;
      }
      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        color: #374151;
      }
      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s ease;
      }
      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #4f46e5;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
      }

      .btn {
        background: linear-gradient(45deg, #4f46e5, #7c3aed);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-right: 10px;
        margin-bottom: 10px;
      }
      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(79, 70, 229, 0.3);
      }
      .btn-secondary {
        background: #6b7280;
      }
      .btn-danger {
        background: #dc2626;
      }

      .table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      .table th,
      .table td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid #e5e7eb;
      }
      .table th {
        background: #f8fafc;
        font-weight: bold;
        color: #374151;
      }
      .table tr:hover {
        background: #f8fafc;
      }

      .config-section {
        background: #f8fafc;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
      }
      .config-section h3 {
        color: #4f46e5;
        margin-bottom: 15px;
      }
      .config-section input,
      .config-section select,
      .config-section textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s ease;
      }

      .alert {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
      }
      .alert-success {
        background: #d1fae5;
        color: #065f46;
      }
      .alert-error {
        background: #fee2e2;
        color: #991b1b;
      }
      .alert-info {
        background: #dbeafe;
        color: #1e40af;
      }

      .loading {
        display: none;
        text-align: center;
        padding: 20px;
      }

      .spinner {
        border: 4px solid #e5e7eb;
        border-top: 4px solid #4f46e5;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }
      .stat-card {
        background: linear-gradient(45deg, #4f46e5, #7c3aed);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
      }
      .stat-number {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
      }
      .modal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 30px;
        border-radius: 15px;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
      }

      .close {
        float: right;
        font-size: 24px;
        cursor: pointer;
        color: #6b7280;
      }
      .close:hover {
        color: #374151;
      }

      /* ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ ë¦¬ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
      .scrollable-list {
        max-height: 600px;
        overflow-y: auto;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸ¯ KCMF ê°•ì˜í‰ê°€ ê´€ë¦¬</h1>
        <p>ì‹œì²­ìë¯¸ë””ì–´ì¬ë‹¨ ì§ì›ìš© ì‹œìŠ¤í…œ</p>
      </div>

      <div class="nav-tabs">
        <button
          class="nav-tab active"
          data-page="config"
          onclick="showPage('config')"
        >
          ğŸ”§ë¡œê·¸ì¸
        </button>
        <button class="nav-tab" data-page="admin1" onclick="showPage('admin1')">
          ğŸ“‹êµìœ¡ ê´€ë¦¬
        </button>
        <button class="nav-tab" data-page="admin2" onclick="showPage('admin2')">
          ğŸ“Šì„¤ë¬¸ í˜„í™©
        </button>
        <button class="nav-tab" data-page="survey" onclick="showPage('survey')">
          ğŸ“ì‘ë‹µ ë‚´ì—­
        </button>
      </div>

      <div class="content">
        <!-- DB ì„¤ì • í˜ì´ì§€ -->
        <div id="config" class="page active">
          <div class="config-section">
            <h3>ë¡œê·¸ì¸</h3>
            <div id="loginform" class="form-group">
              <input type="email" id="login_email" placeholder="ì´ë©”ì¼" />
              <input
                type="password"
                id="login_password"
                placeholder="ë¹„ë°€ë²ˆí˜¸"
              />
              <button id="login_btn" class="btn" onclick="signIn()">
                ë¡œê·¸ì¸
              </button>
              <button
                id="logout_btn"
                class="btn btn-secondary"
                onclick="signOut()"
              >
                ë¡œê·¸ì•„ì›ƒ
              </button>
            </div>
            <div id="authStatus" class="alert alert-info"></div>
          </div>

          <div class="config-section">
            <h3>DB ì„¤ì •</h3>
            <textarea>
ì„¤ì¹˜ ë° ì‚¬ìš©ë°©ë²• ì•Œë ¤ì£¼ê² ë‹¤.
supabaseì—ì„œ ì•„ë˜ ë³µì‚¬ ë¶™ì—¬ë„£ê¸° í•´ë¼.. blah blah
í‚¤ ë°œê¸‰ ë°›ê³  ì†ŒìŠ¤ì½”ë“œì— í‚¤ ì…ë ¥í•´ë¼.. blah blah
    </textarea
            >
            <button class="btn" onclick="testConnection()">ì—°ê²° í…ŒìŠ¤íŠ¸</button>
            <div id="connectionStatus"></div>
          </div>
        </div>

        <!-- ê´€ë¦¬ì í™”ë©´1: êµìœ¡ ê´€ë¦¬ -->
        <div id="admin1" class="page">
          <h2>ğŸ“‹ êµìœ¡ ê²€ìƒ‰</h2>
          <div id="education-search-ui"></div>
          <div style="text-align: right">
            <button class="btn" onclick="openEducationModal('add')">
              ì‹ ê·œ ë“±ë¡
            </button>
          </div>

          <div
            id="educationCount"
            style="margin-bottom: 10px; font-weight: bold"
          ></div>
          <div id="educationList" class="scrollable-list">
            <div class="loading">
              <div class="spinner"></div>
              <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
          </div>
        </div>

        <!-- ê´€ë¦¬ì í™”ë©´2: ì„¤ë¬¸ í˜„í™© -->
        <div id="admin2" class="page">
          <h2>ğŸ“Š ì„¤ë¬¸ ê²€ìƒ‰</h2>
          <div id="survey-search-ui"></div>

          <h2>ğŸ“Š ê²€ìƒ‰ ê²°ê³¼</h2>
          <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
              <div class="stat-number" id="uniqueEducations">0</div>
              <div>êµìœ¡ ê³¼ì •</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="totalResponses">0</div>
              <div>ì´ ì‘ë‹µ ìˆ˜</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="avgRating">0.0</div>
              <div>í‰ê·  ë§Œì¡±ë„</div>
            </div>
          </div>

          <div
            id="surveyCount"
            style="margin-bottom: 10px; font-weight: bold"
          ></div>
          <div id="surveyResults" class="scrollable-list">
            <div class="loading">
              <div class="spinner"></div>
              <p>ì„¤ë¬¸ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
          </div>
        </div>

        <!-- ê´€ë¦¬ì í™”ë©´3: ì‘ë‹µ ë‚´ì—­ -->
        <div id="survey" class="page">


        </div>
      </div>
    </div>

    <!-- êµìœ¡ì •ë³´ ëª¨ë‹¬ -->
    <div id="educationModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeEducationModal()">&times;</span>
        <h3 id="modalTitle">êµìœ¡ ì •ë³´</h3>
        <div class="form-group">
          <label>ì„¼í„°ëª…:</label>
          <select id="modalCenter">
            <option value="">--ì „ì²´--</option>
            <option value="ë¶€ì‚°ì„¼í„°">ë¶€ì‚°ì„¼í„°</option>
            <option value="ê²½ë‚¨ì„¼í„°">ê²½ë‚¨ì„¼í„°</option>
            <option value="ìš¸ì‚°ì„¼í„°">ìš¸ì‚°ì„¼í„°</option>
          </select>
        </div>
        <div class="form-group">
          <label>ê°•ì‚¬ëª…:</label>
          <input type="text" id="modalInstructor" />
        </div>
        <div class="form-group">
          <label>êµìœ¡ëª…:</label>
          <input type="text" id="modalEducation" />
        </div>
        <div class="form-group">
          <label>ì„¤ë¬¸ê¸°ê°„:</label>
          <input type="text" id="modalStartDate" /> ~
          <input type="text" id="modalEndDate" />
        </div>
        <div style="margin-top: 20px">
          <button
            class="btn"
            id="modalActionButton"
            onclick="handleEducationAction()"
          >
            ë“±ë¡
          </button>
          <button class="btn btn-secondary" onclick="closeEducationModal()">
            ì·¨ì†Œ
          </button>
        </div>
      </div>
    </div>

    <script>
// ì„¤ë¬¸íŒŒì¼ ìœ„ì¹˜
// var survey_url = 'https://kcmf.or.kr/survey.html';
var survey_url = String(window.location.href).replace('/manager.html', '/survey.html');

// DB ì ‘ì† ë° ìƒì„±
var supabase = supabase.createClient('https://fnxmyayfosjwuvsxbabm.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZueG15YXlmb3Nqd3V2c3hiYWJtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk2MTg2NzcsImV4cCI6MjA2NTE5NDY3N30.rAldXcD4_tsstfd9xHzKw3QgIHBrHvaFkBv6TJRVhjA')

// Supabase ì—°ê²° í…ŒìŠ¤íŠ¸
async function testConnection() {
    try {
        const { data, error } = await supabase.from('education_info').select('count').limit(1);
        if (error) throw error;
        showAlert('ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í…ŒìŠ¤íŠ¸ ì„±ê³µ!', 'success');
    } catch (error) {
        showAlert('ë°ì´í„°ë² ì´ìŠ¤ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ' + error.message, 'error');
    }
}

// ì•Œë¦¼ í‘œì‹œ
function showAlert(message, type) {
    const statusDiv = document.getElementById('connectionStatus');
    statusDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
    setTimeout(() => {
        statusDiv.innerHTML = '';
    }, 5000);
}

// ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¼ ë¡œê·¸ì¸ í™œì„±í™”/ë¹„í™œì„±í™”
function updateLoginUI(isLoggedIn = false) {
    const emailInput = document.getElementById('login_email');
    const passwordInput = document.getElementById('login_password');
    const loginBtn = document.getElementById('login_btn');
    const logoutBtn = document.getElementById('logout_btn');
    if (isLoggedIn) {
        emailInput.readOnly = true;
        emailInput.style.backgroundColor = '#ddd';
        passwordInput.readOnly = true;
        passwordInput.style.backgroundColor = '#ddd';
        loginBtn.className = 'btn btn-secondary';
        logoutBtn.className = 'btn';
    } else {
        emailInput.readOnly = false;
        emailInput.style.backgroundColor = 'white';
        passwordInput.value = '';
        passwordInput.readOnly = false;
        passwordInput.style.backgroundColor = 'white';
        loginBtn.className = 'btn';
        logoutBtn.className = 'btn btn-secondary';
    }
}


// ë¡œê·¸ì¸ í•¨ìˆ˜
async function signIn() {
    const email = document.getElementById('login_email').value;
    const password = document.getElementById('login_password').value;
    const { data, error } = await supabase.auth.signInWithPassword({
        email: email,
        password: password
    });

    if (error) {
        document.getElementById('authStatus').innerText = 'ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + error.message;
    } else {
        document.getElementById('authStatus').innerText = 'ë¡œê·¸ì¸ ì„±ê³µ! ì‚¬ìš©ì ID: ' + data.user.id;
        updateLoginUI(true);
        showPage('admin1');
    }
}

// ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜
async function signOut() {
    const { error } = await supabase.auth.signOut();
    if (error) {
        document.getElementById('authStatus').innerText = 'ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨: ' + error.message;
    } else {
        document.getElementById('authStatus').innerText = 'ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.';
        updateLoginUI(false);
    }
}

// ë¡œê·¸ì¸ ìƒíƒœ ë³€í™” ê°ì§€
supabase.auth.onAuthStateChange(async (event, session) => {
    if (session && session.user) {
        document.getElementById('authStatus').innerText = `ë¡œê·¸ì¸ ìƒíƒœ: ${session.user.id}`;
        updateLoginUI(true);
        showPage('admin1');
    } else {
        document.getElementById('authStatus').innerText = 'ë¡œê·¸ì¸ ìƒíƒœ: ë¡œê·¸ì•„ì›ƒë¨';
        updateLoginUI(false);
        showPage('config');
    }
});

// í˜ì´ì§€ ì „í™˜
async function showPage(pageId) {

    // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ (ë¡œê·¸ì¸ ì•ˆí–ˆìœ¼ë©´ ì„¤ì • í™”ë©´ìœ¼ë¡œ ì´ë™)
    const { data: { session } } = await supabase.auth.getSession();
    if (!session || !session.user) pageId = "config";

    // ëª¨ë“  í˜ì´ì§€ ìˆ¨ê¸°ê¸°
    document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
    });

    // ëª¨ë“  íƒ­ ë¹„í™œì„±í™”
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
    });

    // ì„ íƒëœ í˜ì´ì§€ í‘œì‹œ
    document.getElementById(pageId).classList.add('active');
    const activeTab = document.querySelector(`.nav-tab[data-page="${pageId}"]`);
    if (activeTab) activeTab.classList.add('active');

    // í˜ì´ì§€ë³„ ì´ˆê¸° í™”ë©´ ë¡œë”© (ìµœì´ˆ ì§„ì… ì‹œì• ë§Œ)
    if (pageId === 'admin1') {
      const searchUI = document.getElementById('education-search-ui');
      if (!searchUI.hasChildNodes()) {
        educationPage = 0;
        currentEducations = [];
        // ê¸°ì¡´ ìŠ¤í¬ë¡¤ ë¦¬ìŠ¤ë„ˆ ì œê±° (ì¤‘ë³µ ë°©ì§€)
        const listDiv = document.getElementById('educationList');
        if (listDiv && listDiv.hasScrollListener) {
            listDiv.removeEventListener('scroll', handleEducationScroll);
            listDiv.hasScrollListener = false;
        }
        // ê²€ìƒ‰ ì¸í„°í˜ì´ìŠ¤ ìƒì„±
        createSearchInterface(
            'education-search-ui',
            (filters) => { // ê²€ìƒ‰ ì½œë°±
                educationPage = 0;
                currentEducations = [];
                loadEducations(filters);
            },
            () => { // ì´ˆê¸°í™” ì½œë°±
                educationPage = 0;
                currentEducations = [];
                loadEducations();
            }
          );
          loadEducations();
      }
    } else if (pageId === 'admin2') {
      // ê²€ìƒ‰ ì¸í„°í˜ì´ìŠ¤ê°€ ì—†ì„ ë•Œë§Œ ìƒì„± (ìµœì´ˆ ì§„ì…)
      const searchUI = document.getElementById('survey-search-ui');
      if (!searchUI.hasChildNodes()) {
        surveyPage = 0;
        currentSurveyResults = [];
        // ê¸°ì¡´ ìŠ¤í¬ë¡¤ ë¦¬ìŠ¤ë„ˆ ì œê±° (ì¤‘ë³µ ë°©ì§€)
        const surveyDiv = document.getElementById('surveyResults');
        if (surveyDiv && surveyDiv.hasScrollListener) {
            surveyDiv.removeEventListener('scroll', handleSurveyScroll);
            surveyDiv.hasScrollListener = false;
        }
        // ê²€ìƒ‰ ì¸í„°í˜ì´ìŠ¤ ìƒì„±
        createSearchInterface(
            'survey-search-ui',
            (filters) => { // ê²€ìƒ‰ ì½œë°±
                surveyPage = 0;
                currentSurveyResults = [];
                loadSurveyResults(filters);
            },
            () => { // ì´ˆê¸°í™” ì½œë°±
                surveyPage = 0;
                currentSurveyResults = [];
                loadSurveyResults();
            }
        );
        loadSurveyResults();
      }
    } else {
        // ë‹¤ë¥¸ í˜ì´ì§€ë¡œ ì´ë™í•  ë•Œ ìƒíƒœ ì •ë¦¬
        const listDiv = document.getElementById('educationList');
        if (listDiv && listDiv.hasScrollListener) {
            listDiv.removeEventListener('scroll', handleEducationScroll);
            listDiv.hasScrollListener = false;
        }
        const surveyDiv = document.getElementById('surveyResults');
        if (surveyDiv && surveyDiv.hasScrollListener) {
            surveyDiv.removeEventListener('scroll', handleSurveyScroll);
            surveyDiv.hasScrollListener = false;
        }
        window.isLoadingEducations = false;
        window.isLoadingSurveys = false;
    }
}

function generateUniqueKey(center, instructor) {
    // ë¬¸ìì—´ ê¸¸ì´ ê¸°ë°˜ ê°„ë‹¨í•œ í•´ì‹œ (ê° ë¬¸ìì˜ ì½”ë“œê°’ í•©ì‚°)
    let hash = center.length + instructor.length;
    for (let i = 0; i < center.length; i++) {
        hash += center.charCodeAt(i);
    }
    for (let i = 0; i < instructor.length; i++) {
        hash += instructor.charCodeAt(i);
    }
    // 36ì§„ë²•ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ì§§ê²Œ ë§Œë“¤ê¸°
    const hashStr = (hash % 1679616).toString(36); // 1679616 = 36^4, ìµœëŒ€ 4ìë¦¬
    // í˜„ì¬ ì‹œê°„ì—ì„œ 2000ë…„ì„ ë¹¼ë²„ë¦¬ë©´ ë‚¨ì€ ìˆ«ìê°€ ì¤„ì–´ë“ ë‹¤
    const now = Date.now();
    const year2000 = new Date('2000-01-01').getTime();
    const timeStr = (now - year2000).toString(36);
    return `${hashStr}${timeStr}`;
}

let editingEducationId = null; // ìˆ˜ì • ëª¨ë“œì¼ ë•Œë§Œ ì‚¬ìš©
let modalMode = 'add'; // êµìœ¡ ì¶”ê°€ ìˆ˜ì • ì‹œ 'add' ë˜ëŠ” 'edit' ëª¨ë“œ

const recordsPerPage = 50; // í˜ì´ì§€ë‹¹ ë ˆì½”ë“œ ìˆ˜

// êµìœ¡ ê´€ë¦¬ ê´€ë ¨ ì „ì—­ ë³€ìˆ˜
let educationPage = 0; 
let educationIsLoading = false;
let educationHasMore = true;
let currentEducations = [];

// ì„¤ë¬¸ í˜„í™© ê´€ë ¨ ì „ì—­ ë³€ìˆ˜
let surveyPage = 0;
let surveyIsLoading = false;
let surveyHasMore = true;
let currentSurveyResults = [];

/**
 * ì¬ì‚¬ìš© ê°€ëŠ¥í•œ ê²€ìƒ‰ UIë¥¼ ìƒì„±í•˜ê³  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì—°ê²°í•©ë‹ˆë‹¤.
 * @param {string} containerId - ê²€ìƒ‰ UIê°€ ì‚½ì…ë  divì˜ ID
 * @param {function} onSearch - 'ê²€ìƒ‰' ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰ë  ì½œë°± í•¨ìˆ˜
 * @param {function} onReset - 'ì´ˆê¸°í™”' ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰ë  ì½œë°± í•¨ìˆ˜
 */
function createSearchInterface(containerId, onSearch, onReset) {
    const container = document.getElementById(containerId);
    if (!container) return;

    // ê²€ìƒ‰ UIì˜ HTML êµ¬ì¡°
    container.innerHTML = `
    <div class="form-group" style="margin-top: 20px; margin-bottom: 20px; padding: 20px; background: #f8fafc; border-radius: 8px;">
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
        <div class="form-group">
          <label>ì„¼í„°ëª…:</label>
          <!--<input type="text" class="search-center" placeholder="ì„¼í„°ëª… ì…ë ¥">-->
          <select id="modalCenter" class="search-center">
            <option value="">--ì „ì²´--</option>
            <option value="ë¶€ì‚°ì„¼í„°">ë¶€ì‚°ì„¼í„°</option>
            <option value="ê²½ë‚¨ì„¼í„°">ê²½ë‚¨ì„¼í„°</option>
            <option value="ìš¸ì‚°ì„¼í„°">ìš¸ì‚°ì„¼í„°</option>
          </select>
        </div>
        <div class="form-group">
          <label>ê°•ì‚¬ëª…:</label>
          <input type="text" class="search-instructor" placeholder="ê°•ì‚¬ëª… ì…ë ¥">
        </div>
        <div class="form-group">
          <label>êµìœ¡ëª…:</label>
          <input type="text" class="search-education" placeholder="êµìœ¡ëª… ì…ë ¥">
        </div>
      </div>
      <button class="btn search-btn">ê²€ìƒ‰</button>
      <button class="btn btn-secondary reset-btn">ê²€ìƒ‰ ì´ˆê¸°í™”</button>
    </div>
    `;

    // ìƒì„±ëœ UI ë‚´ì˜ ìš”ì†Œì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
    const searchBtn = container.querySelector('.search-btn');
    const resetBtn = container.querySelector('.reset-btn');
    const centerInput = container.querySelector('.search-center');
    const instructorInput = container.querySelector('.search-instructor');
    const educationInput = container.querySelector('.search-education');

    // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    searchBtn.addEventListener('click', () => {
        const filters = {
            center: centerInput.value,
            instructor: instructorInput.value,
            education: educationInput.value,
        };
        onSearch(filters); // ì „ë‹¬ë°›ì€ onSearch ì½œë°± í•¨ìˆ˜ ì‹¤í–‰
    });

    // ì´ˆê¸°í™” ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    resetBtn.addEventListener('click', () => {
        centerInput.value = '';
        instructorInput.value = '';
        educationInput.value = '';
        onReset(); // ì „ë‹¬ë°›ì€ onReset ì½œë°± í•¨ìˆ˜ ì‹¤í–‰
    });
}

// êµìœ¡ ëª©ë¡ ë¡œë“œ (ê²€ìƒ‰ ë° í˜ì´ì§• ì ìš©)
async function loadEducations(filters = {}) {
    if (educationIsLoading) return;
    educationIsLoading = true;

    if (!supabase) {
        document.getElementById('educationList').innerHTML = '<div class="alert alert-error">ë¨¼ì € Supabaseì— ì—°ê²°í•´ì£¼ì„¸ìš”.</div>';
        return;
    }

    const listDiv = document.getElementById('educationList');
    const loadingDiv = listDiv.querySelector('.loading');
    if (loadingDiv) loadingDiv.style.display = 'block';

    // ê²€ìƒ‰ ì‹œ ë˜ëŠ” ì²« ë¡œë“œ ì‹œ currentEducations ì´ˆê¸°í™”
    if (educationPage === 0) {
        currentEducations = [];
        listDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>';
    }

    // ì´ë¯¸ ë¡œë”© ì¤‘ì¸ì§€ í™•ì¸í•˜ì—¬ ì¤‘ë³µ ìš”ì²­ ë°©ì§€
    if (window.isLoadingEducations) {
        return;
    }
    window.isLoadingEducations = true;

    let query = supabase.from('education_info').select('*', { count: 'exact' });

    // ê²€ìƒ‰ ì¡°ê±´ ì¶”ê°€
    if (filters.center) {
        query = query.ilike('center_name', `%${filters.center}%`);
    }
    if (filters.instructor) {
        query = query.ilike('instructor_name', `%${filters.instructor}%`);
    }
    if (filters.education) {
        query = query.ilike('education_name', `%${filters.education}%`);
    }

    // í˜ì´ì§• ì ìš©
    const from = educationPage * recordsPerPage;
    const to = from + recordsPerPage - 1;
    query = query.order('created_at', { ascending: false }).range(from, to);

    try {
        const { data, error, count } = await query;
        if (error) throw error;

        currentEducations = currentEducations.concat(data); // ìƒˆë¡œ ë¶ˆëŸ¬ì˜¨ ë°ì´í„°ë¥¼ ê¸°ì¡´ ë°ì´í„°ì— ì¶”ê°€

        displayEducations(currentEducations, count, educationPage === 0); // isInitialRender í”Œë˜ê·¸ ì¶”ê°€

        if (loadingDiv) loadingDiv.style.display = 'none';

        // ìŠ¤í¬ë¡¤ ë¡œë“œë¥¼ ìœ„í•œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ìµœì´ˆ ë¡œë“œ ì‹œì—ë§Œ)
        if (!listDiv.hasScrollListener) {
            listDiv.addEventListener('scroll', handleEducationScroll);
            listDiv.hasScrollListener = true;
        }
        window.isLoadingEducations = false; // ë¡œë”© ìƒíƒœ í•´ì œ

    } catch (error) {
        document.getElementById('educationList').innerHTML = `<div class="alert alert-error">ë¡œë”© ì‹¤íŒ¨: ${error.message}</div>`;
        if (loadingDiv) loadingDiv.style.display = 'none';

    } finally {
        educationIsLoading = false;
    }
}

// êµìœ¡ ëª©ë¡ í‘œì‹œ (ê²€ìƒ‰ ê±´ìˆ˜ ì—…ë°ì´íŠ¸ í¬í•¨)
function displayEducations(educations, totalCount, isInitialRender = false) {
    const listDiv = document.getElementById('educationList');
    const educationCountDiv = document.getElementById('educationCount');

    educationCountDiv.textContent = `ì´ ${totalCount}ê±´ì˜ êµìœ¡ ê³¼ì •ì´ ê²€ìƒ‰ë˜ì—ˆìŠµë‹ˆë‹¤.`;

    if (educations.length === 0) {
        listDiv.innerHTML = '<div class="alert alert-info">ë“±ë¡ëœ êµìœ¡ ê³¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
    }

    let html = `
    <table class="table">
    <thead>
    <tr>
    <th width="12%">ì„¼í„°</th>
    <th width="11%">ê°•ì‚¬ëª…</th>
    <th width="28%">êµìœ¡ëª…</th>
    <th width="14%">ì„¤ë¬¸ê¸°ê°„</th>
    <th width="16%">ì„¤ë¬¸ URL<br/>(ê³ ìœ í‚¤)</th>
    <th width="19%">ì‘ì—…</th>
    </tr>
    </thead>
    <tbody>
    `;

    educations.forEach(edu => {
        html += `
    <tr>
    <td><code>${edu.center_name}</code></td>
    <td>${edu.instructor_name}</td>
    <td>${edu.education_name}</td>
    <td><code>${edu.start_date}<br/>~${edu.end_date}</code></td>
    <td><a href="${survey_url}#s=${edu.unique_key}" target="_blank" style="color: #4f46e5;">${edu.unique_key}</a></td>
    <td>
    <button class="btn" onclick="openEducationModal('edit', ${edu.id})" style="padding: 5px 10px; font-size: 0.8rem;">ìˆ˜ì •</button>
    <button class="btn btn-danger" onclick="deleteEducation(${edu.id},'${edu.unique_key}')" style="padding: 5px 10px; font-size: 0.8rem;">ì‚­ì œ</button>
    </td>
    </tr>
    `;
    });

    html += '</tbody></table>';
    listDiv.innerHTML = html;
}

// êµìœ¡ ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
function handleEducationScroll() {
    const listDiv = document.getElementById('educationList');
    // ì´ë¯¸ ë¡œë”© ì¤‘ì´ë©´ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
    if (window.isLoadingEducations) return;
    // ìŠ¤í¬ë¡¤ì´ ëì—ì„œ 50px ì •ë„ê¹Œì§€ ê°€ë©´ ì¶”ê°€ ë¡œë“œ
    if (listDiv.scrollTop + listDiv.clientHeight >= listDiv.scrollHeight - 50) {
        educationPage++;
        loadEducations();
    }
}

// êµìœ¡ ì •ë³´ ëª¨ë‹¬ ì—´ê¸° (ì¶”ê°€/ìˆ˜ì • ê²¸ìš©)
function openEducationModal(mode, id = null) {
    modalMode = mode;
    const modalTitle = document.getElementById('modalTitle');
    const modalActionButton = document.getElementById('modalActionButton');

    // í•„ë“œ ì´ˆê¸°í™”
    document.getElementById('modalCenter').selectedIndex = 0;
    document.getElementById('modalInstructor').value = '';
    document.getElementById('modalEducation').value = '';
    document.getElementById('modalStartDate').value = '';
    document.getElementById('modalEndDate').value = '';
    editingEducationId = null; // ì´ˆê¸°í™”

    if (mode === 'add') {
        modalTitle.textContent = 'ìƒˆ êµìœ¡ ì •ë³´ ë“±ë¡';
        modalActionButton.textContent = 'ë“±ë¡';
        modalActionButton.onclick = addEducation; // ë“±ë¡ í•¨ìˆ˜ ì—°ê²°
        // ê¸°ë³¸ê°’ìœ¼ë¡œ ì˜¤ëŠ˜ ë‚ ì§œì™€ 4ì£¼í›„ ë‚ ì§œë¥¼ ì„¤ì • (YYYY-MM-DD)
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0'); // ì›”ì€ 0ë¶€í„° ì‹œì‘í•˜ë¯€ë¡œ +1
        const day = String(today.getDate()).padStart(2, '0');
        document.getElementById('modalStartDate').value = `${year}-${month}-${day}`;
        const fourWeeksLater = new Date();
        fourWeeksLater.setDate(today.getDate() + 28); // ì˜¤ëŠ˜ ë‚ ì§œì— 28ì¼ (4ì£¼) ë”í•˜ê¸°
        const endYear = fourWeeksLater.getFullYear();
        const endMonth = String(fourWeeksLater.getMonth() + 1).padStart(2, '0');
        const endDay = String(fourWeeksLater.getDate()).padStart(2, '0');
        document.getElementById('modalEndDate').value = `${endYear}-${endMonth}-${endDay}`;

    } else if (mode === 'edit') {
        modalTitle.textContent = 'êµìœ¡ ì •ë³´ ìˆ˜ì •';
        modalActionButton.textContent = 'ìˆ˜ì •';
        modalActionButton.onclick = updateEducation; // ìˆ˜ì • í•¨ìˆ˜ ì—°ê²°

        const education = currentEducations.find(edu => edu.id === id);
        if (!education) {
            showAlert('ìˆ˜ì •í•  êµìœ¡ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
            return;
        }
        editingEducationId = id;
        document.getElementById('modalCenter').value = education.center_name;
        document.getElementById('modalInstructor').value = education.instructor_name;
        document.getElementById('modalEducation').value = education.education_name;
        document.getElementById('modalStartDate').value = education.start_date;
        document.getElementById('modalEndDate').value = education.end_date;
    }
    document.getElementById('educationModal').style.display = 'block';
}

// êµìœ¡ ì •ë³´ ëª¨ë‹¬ ë‹«ê¸°
function closeEducationModal() {
    document.getElementById('educationModal').style.display = 'none';
}

// ëª¨ë‹¬ ì•¡ì…˜ í•¸ë“¤ëŸ¬ (ì¶”ê°€ ë˜ëŠ” ìˆ˜ì • í•¨ìˆ˜ë¥¼ í˜¸ì¶œ)
function handleEducationAction() {
    if (modalMode === 'add') {
        addEducation();
    } else if (modalMode === 'edit') {
        updateEducation();
    }
}

// êµìœ¡ ì •ë³´ ì¶”ê°€
async function addEducation() {
    if (!supabase) {
        showAlert('ë¨¼ì € Supabaseì— ì—°ê²°í•´ì£¼ì„¸ìš”.', 'error');
        return;
    }

    const instructor = document.getElementById('modalInstructor').value;
    const education = document.getElementById('modalEducation').value;
    const center = document.getElementById('modalCenter').value;
    const uniqueKey = generateUniqueKey(instructor, education, center);
    const start_date = document.getElementById('modalStartDate').value;
    const end_date = document.getElementById('modalEndDate').value;

    if (!instructor || !education || !center || !start_date || !end_date) {
        showAlert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
        return;
    }

    try {
        const { data, error } = await supabase
            .from('education_info')
            .insert([{
                unique_key: uniqueKey,
                center_name: center,
                instructor_name: instructor,
                education_name: education,
                start_date: start_date,
                end_date: end_date
            }]);

        if (error) throw error;

        showAlert('êµìœ¡ ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        closeEducationModal();
        educationPage = 0;
        currentEducations = [];
        loadEducations();
    } catch (error) {
        showAlert('ì¶”ê°€ ì‹¤íŒ¨: ' + error.message, 'error');
    }
}

// êµìœ¡ ì •ë³´ ì—…ë°ì´íŠ¸
// ì£¼ì˜: unique_key ê°’ì€ ë³€ê²½í•˜ì§€ ì•ŠëŠ”ë‹¤. (ë³€ê²½í•˜ë©´ ê¸°ì¡´ ì„¤ë¬¸ì€ ëª¨ë‘ ë¬´íš¨ê°€ ë¨.)
async function updateEducation() {
    const center = document.getElementById('modalCenter').value;
    const instructor = document.getElementById('modalInstructor').value;
    const education = document.getElementById('modalEducation').value;
    const start_date = document.getElementById('modalStartDate').value;
    const end_date = document.getElementById('modalEndDate').value;

    if (!instructor || !education || !center || !start_date || !end_date) {
        showAlert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
        return;
    }

    try {
        const { data, error } = await supabase
            .from('education_info')
            .update({
                center_name: center,
                instructor_name: instructor,
                education_name: education,
                start_date: start_date,
                end_date: end_date,
            })
            .eq('id', editingEducationId);

        if (error) throw error;

        showAlert('êµìœ¡ ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        closeEducationModal();
        educationPage = 0;
        currentEducations = [];
        loadEducations();
    } catch (error) {
        showAlert('ìˆ˜ì • ì‹¤íŒ¨: ' + error.message, 'error');
    }
}

// ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸° (educationModal í•˜ë‚˜ë§Œ ì²˜ë¦¬)
window.onclick = function (event) {
    const educationModal = document.getElementById('educationModal');
    if (event.target === educationModal) {
        closeEducationModal();
    }
}

// êµìœ¡ ì •ë³´ ì‚­ì œ
// TODO: ì„¤ë¬¸ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì‚­ì œí•˜ë©´ ì•ˆë¨.
async function deleteEducation(id, unique_key) {
    if (!confirm('ì •ë§ë¡œ ì´ êµìœ¡ ì •ë³´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    try {
        const { data, error } = await supabase
            .from('education_info')
            .delete()
            .eq('id', id)
            .eq('unique_key', unique_key);

        if (error) throw error;

        showAlert('êµìœ¡ ì •ë³´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        educationPage = 0;
        currentEducations = [];
        loadEducations();
    } catch (error) {
        showAlert('ì‚­ì œ ì‹¤íŒ¨: ' + error.message, 'error');
    }
}

// ì„¤ë¬¸ ê²°ê³¼ ë¡œë“œ (ê²€ìƒ‰ ê¸°ëŠ¥ ë° í˜ì´ì§• í¬í•¨)
async function loadSurveyResults(filters = {}) {
    if (surveyIsLoading) return;
    surveyIsLoading = true;

    if (!supabase) {
        document.getElementById('surveyResults').innerHTML = '<div class="alert alert-error">ë¨¼ì € Supabaseì— ì—°ê²°í•´ì£¼ì„¸ìš”.</div>';
        return;
    }

    const surveyResultsDiv = document.getElementById('surveyResults');
    const loadingDiv = surveyResultsDiv.querySelector('.loading');
    if (loadingDiv) loadingDiv.style.display = 'block';

    // ê²€ìƒ‰ ì‹œ ë˜ëŠ” ì²« ë¡œë“œ ì‹œ currentSurveyResults ì´ˆê¸°í™”
    if (surveyPage === 0) {
        currentSurveyResults = [];
        surveyResultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>ì„¤ë¬¸ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>';
    }

    // ì´ë¯¸ ë¡œë”© ì¤‘ì¸ì§€ í™•ì¸í•˜ì—¬ ì¤‘ë³µ ìš”ì²­ ë°©ì§€
    if (window.isLoadingSurveys) {
        return;
    }
    window.isLoadingSurveys = true;

    try {
        let query = supabase.from('survey_results').select('*', { count: 'exact' });

        // ê²€ìƒ‰ ì¡°ê±´ ì¶”ê°€ (filters ê°ì²´ ì‚¬ìš©)
        if (filters.center) {
            query = query.ilike('center_name', `%${filters.center}%`);
        }
        if (filters.instructor) {
            query = query.ilike('instructor_name', `%${filters.instructor}%`);
        }
        if (filters.education) {
            query = query.ilike('education_name', `%${filters.education}%`);
        }

        // í˜ì´ì§• ì ìš©
        const from = surveyPage * recordsPerPage;
        const to = from + recordsPerPage - 1;
        query = query.order('submitted_at', { ascending: false }).range(from, to);

        const { data, error, count } = await query;
        if (error) throw error;

        currentSurveyResults = currentSurveyResults.concat(data); // ìƒˆë¡œ ë¶ˆëŸ¬ì˜¨ ë°ì´í„°ë¥¼ ê¸°ì¡´ ë°ì´í„°ì— ì¶”ê°€

        displaySurveyResults(currentSurveyResults, count, surveyPage === 0);
        updateStats(currentSurveyResults, count);

        if (loadingDiv) loadingDiv.style.display = 'none';

        // ìŠ¤í¬ë¡¤ ë¡œë“œë¥¼ ìœ„í•œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ìµœì´ˆ ë¡œë“œ ì‹œì—ë§Œ)
        if (!surveyResultsDiv.hasScrollListener) {
            surveyResultsDiv.addEventListener('scroll', handleSurveyScroll);
            surveyResultsDiv.hasScrollListener = true;
        }
        window.isLoadingSurveys = false; // ë¡œë”© ìƒíƒœ í•´ì œ

    } catch (error) {
        surveyResultsDiv.innerHTML = `<div class="alert alert-error">ë¡œë”© ì‹¤íŒ¨: ${error.message}</div>`;
        if (loadingDiv) loadingDiv.style.display = 'none';
    } finally {
        surveyIsLoading = false;
    }
}

// ì„¤ë¬¸ ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
function handleSurveyScroll() {
    const surveyDiv = document.getElementById('surveyResults');
    // ì´ë¯¸ ë¡œë”© ì¤‘ì´ë©´ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
    if (window.isLoadingSurveys) return;
    // ìŠ¤í¬ë¡¤ì´ ëì—ì„œ 50px ì •ë„ê¹Œì§€ ê°€ë©´ ì¶”ê°€ ë¡œë“œ
    if (surveyDiv.scrollTop + surveyDiv.clientHeight >= surveyDiv.scrollHeight - 50) {
        surveyPage++;
        loadSurveyResults();
    }
}

// í†µê³„ ì—…ë°ì´íŠ¸
function updateStats(results, totalCount) {
    const totalResponses = totalCount || results.length;
    let totalScore = 0;
    // ê³ ìœ í•œ êµìœ¡ ê³¼ì • ìˆ˜ ê³„ì‚° (ì„¼í„°ëª… + ê°•ì‚¬ëª… + êµìœ¡ëª… ì¡°í•©ìœ¼ë¡œ ì¤‘ë³µ ì œê±°)
    const uniqueEducations = new Set();
    // ì „ì²´ êµìœ¡ ìˆ˜: êµìœ¡ê³¼ì • ê²€ìƒ‰ currentEducations.length

    if (results.length > 0) {
        results.forEach(
          result => {
            totalScore += (result.q1_rating + result.q2_rating + result.q3_rating + result.q4_rating + result.q5_rating +
                result.q6_rating + result.q7_rating + result.q8_rating + result.q9_rating + result.q10_rating) / 10;

            // ê³ ìœ í•œ êµìœ¡ ê³¼ì • ì‹ë³„ (ì„¼í„°ëª… + ê°•ì‚¬ëª… + êµìœ¡ëª… ì¡°í•©)
            const educationKey = `${result.center_name}|${result.instructor_name}|${result.education_name}`;
            uniqueEducations.add(educationKey);
          }
        );

    }
    const uniqueEducationCount = uniqueEducations.size;

    document.getElementById('totalResponses').textContent = totalResponses;
    document.getElementById('avgRating').textContent = results.length > 0 ? (totalScore / results.length).toFixed(1) : '0.0';
    document.getElementById('uniqueEducations').textContent = uniqueEducationCount;
}


// ì‘ë‹µ ë‚´ì—­ í‘œì‹œ (ê²€ìƒ‰ ê±´ìˆ˜ ì—…ë°ì´íŠ¸ í¬í•¨)
// displaySurveyResults(currentSurveyResults, count, surveyPage === 0);
function displaySurveyResults(results, totalCount, isInitialRender = false) {
    const surveyResultsDiv = document.getElementById('surveyResults');
    const surveyCountDiv = document.getElementById('surveyCount');

    surveyCountDiv.textContent = `ì´ ${totalCount}ê±´ì˜ ì„¤ë¬¸ ì‘ë‹µì´ ê²€ìƒ‰ë˜ì—ˆìŠµë‹ˆë‹¤.`;

    if (results.length === 0) {
        surveyResultsDiv.innerHTML = '<div class="alert alert-info">ì‘ë‹µ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
    }

    let html = `
    <table class="table">
    <thead>
    <tr>
    <th width="14%">ì‘ë‹µì¼</th>
    <th width="10%">ì„¼í„°ëª…</th>
    <th width="10%">ê°•ì‚¬ëª…</th>
    <th width="24%">êµìœ¡ëª…</th>
    <th width="10%">ì‘ë‹µì</th>
    <th width="9%">ì—°ë ¹ëŒ€</th>
    <th width="11%">í‰ê· ì ìˆ˜</th>
    <th width="11%">ì‘ë‹µë‚´ì—­</th>
    </tr>
    </thead>
    <tbody>
    `;

    results.forEach(
      result => {
        const avgScore = ((result.q1_rating + result.q2_rating + result.q3_rating + result.q4_rating + result.q5_rating +
            result.q6_rating + result.q7_rating + result.q8_rating + result.q9_rating + result.q10_rating) / 10).toFixed(1);

        html += `
          <tr>
          <td><code>${new Date(result.submitted_at).toLocaleDateString('ko-KR', {
            year: '2-digit',
            month: '2-digit',
            day: '2-digit'
        })}</code></td>
          <td><code>${result.center_name}</code></td>
          <td>${result.instructor_name}</td>
          <td>${result.education_name}</td>
          <td><code>${result.respondent_name}</code></td>
          <td>${result.age_group}</td>
          <td><strong>${avgScore}</strong></td>
          <td><button class="btn" onclick="showResultDetail('${result.unique_key}')" style="padding: 5px 10px; font-size: 0.8rem;">ìƒì„¸</button></td>
          </tr>
        `;
      }
    );

    html += '</tbody></table>';
    surveyResultsDiv.innerHTML = html;
}

// ì‘ë‹µ ìƒì„¸ ë‚´ì—­ í‘œì‹œ í•¨ìˆ˜
async function showResultDetail(uniqueKey) {
    if (!supabase) {
        showAlert('ë¨¼ì € Supabaseì— ì—°ê²°í•´ì£¼ì„¸ìš”.', 'error');
        return;
    }

    // ì‘ë‹µë‚´ì—­ íƒ­ìœ¼ë¡œ ì´ë™
    showPage('survey');
    
    const surveyPage = document.getElementById('survey');
    surveyPage.innerHTML = `
        <div class="loading">
            <div class="spinner"></div>
            <p>ì‘ë‹µ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
    `;

    try {
        // unique_keyë¡œ survey_results í…Œì´ë¸”ì—ì„œ ëª¨ë“  ì‘ë‹µ ì¡°íšŒ
        const { data, error } = await supabase
            .from('survey_results')
            .select('*')
            .eq('unique_key', uniqueKey)
            .order('submitted_at', { ascending: false });

        if (error) throw error;

        displayDetailedResults(data, uniqueKey);

    } catch (error) {
        surveyPage.innerHTML = `
            <div class="alert alert-error">
                ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: ${error.message}
            </div>
        `;
    }
}

// ìƒì„¸ ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜
function displayDetailedResults(results, uniqueKey) {
    const surveyPage = document.getElementById('survey');
    
    if (results.length === 0) {
        surveyPage.innerHTML = `
            <div class="alert alert-info">
                <h3>ì‘ë‹µ ë‚´ì—­</h3>
                <p>ê³ ìœ í‚¤ "${uniqueKey}"ì— ëŒ€í•œ ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
        `;
        return;
    }

    // êµìœ¡ ì •ë³´ (ì²« ë²ˆì§¸ ì‘ë‹µì—ì„œ ì¶”ì¶œ)
    const educationInfo = results[0];
    
    // í†µê³„ ê³„ì‚°
    const totalResponses = results.length;
    let totalScore = 0;
    results.forEach(result => {
        totalScore += (result.q1_rating + result.q2_rating + result.q3_rating + result.q4_rating + result.q5_rating +
            result.q6_rating + result.q7_rating + result.q8_rating + result.q9_rating + result.q10_rating) / 10;
    });
    const avgScore = (totalScore / totalResponses).toFixed(1);

    let html = `
        <div style="margin-bottom: 20px;">
            <h2>ğŸ“ ì‘ë‹µ ìƒì„¸ ë‚´ì—­</h2>
            <div class="alert alert-info">
                <strong>ì„¤ë¬¸ë²ˆí˜¸(ê³ ìœ í‚¤):</strong> ${uniqueKey} | <strong>ì„¼í„°:</strong> ${educationInfo.center_name} <br>
                <strong>ê°•ì‚¬:</strong> ${educationInfo.instructor_name} | ${educationInfo.education_name} } <strong>êµìœ¡ëª…:</strong> ${educationInfo.education_name}<br>
                <strong>ì´ ì‘ë‹µ ìˆ˜:</strong> ${totalResponses}ê±´ | <strong>í‰ê·  ë§Œì¡±ë„:</strong> ${avgScore}ì 
            </div>
        </div>

        <div class="scrollable-list">
            <table class="table">
                <thead>
                    <tr>
                        <th width="8%">ì‘ë‹µì¼</th>
                        <th width="8%">ì‘ë‹µì</th>
                        <th width="6%">ì—°ë ¹ëŒ€</th>
                        <th width="6%">Q1</th>
                        <th width="6%">Q2</th>
                        <th width="6%">Q3</th>
                        <th width="6%">Q4</th>
                        <th width="6%">Q5</th>
                        <th width="6%">Q6</th>
                        <th width="6%">Q7</th>
                        <th width="6%">Q8</th>
                        <th width="6%">Q9</th>
                        <th width="6%">Q10</th>
                        <th width="6%">í‰ê· </th>
                        <th width="18%">ì˜ê²¬</th>
                    </tr>
                </thead>
                <tbody>
    `;

    results.forEach(result => {
        const avgScore = ((result.q1_rating + result.q2_rating + result.q3_rating + result.q4_rating + result.q5_rating +
            result.q6_rating + result.q7_rating + result.q8_rating + result.q9_rating + result.q10_rating) / 10).toFixed(1);
        
        const submittedDate = new Date(result.submitted_at).toLocaleDateString('ko-KR', {
            year: '2-digit',
            month: '2-digit',
            day: '2-digit'
        });

        html += `
            <tr>
                <td><code>${submittedDate}</code></td>
                <td><code>${result.respondent_name}</code></td>
                <td>${result.age_group}</td>
                <td>${result.q1_rating}</td>
                <td>${result.q2_rating}</td>
                <td>${result.q3_rating}</td>
                <td>${result.q4_rating}</td>
                <td>${result.q5_rating}</td>
                <td>${result.q6_rating}</td>
                <td>${result.q7_rating}</td>
                <td>${result.q8_rating}</td>
                <td>${result.q9_rating}</td>
                <td>${result.q10_rating}</td>
                <td><strong>${avgScore}</strong></td>
                <td style="font-size: 0.9em;">${result.additional_comments || '-'}</td>
            </tr>
        `;
    });

    html += `
                </tbody>
            </table>
        </div>

        <div style="text-align: right">
          <button class="btn" onclick="downloadXLSData('${educationInfo.center_name}')">
            ${educationInfo.center_name} ì „ì²´ ì‘ë‹µ ë‹¤ìš´ë¡œë“œ
          </button>
          <br />ìœ„ì— í‘œì‹œëœ ë‚´ìš© ë§ê³  ì „ì²´ ë°ì´í„°ë¥¼ ì•¡ì…€íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œë°›ìŠµë‹ˆë‹¤.
        </div>
        <div id="ResultAlertDiv"></div>
      `;

    surveyPage.innerHTML = html;
}

// í•„í„°ë§ëœ ë°ì´í„° ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
// downloadFilteredDataAsXLS('ì„¼í„°ëª…', { instructer_name: 'ì•„ë¬´ê°œ', agegroup: '10ëŒ€' })
async function downloadXLSData(center_name, filters = {}) {
    try {
        const ResultAlertDiv = document.getElementById("ResultAlertDiv");
        let query = supabase.from('survey_results').select('*');
        if (center_name) {
            query = query.ilike('center_name', `%${center_name}%`);
        }
        // í•„í„° ì ìš©
        Object.entries(filters).forEach(([column, value]) => {
            query = query.eq(column, value)
        })

        const { data, error } = await query
        if (error) {
          ResultAlertDiv.innerHTML = `<div class="alert alert-error">ë°ì´í„° ì¡°íšŒ ì˜¤ë¥˜: ${error.message}</div>`;
          return
        }
        if (!data || data.length === 0) {
          ResultAlertDiv.innerHTML = `<div class="alert alert-error">ì¡°ê±´ì— ë§ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤: ${error.message}</div>`;
          return
        }
        
        const workbook = XLSX.utils.book_new()
        const worksheet = XLSX.utils.json_to_sheet(data)
        XLSX.utils.book_append_sheet(workbook, worksheet, center_name)
        
        const downloadFileName = `${center_name}_ì„¤ë¬¸ì‘ë‹µ_${new Date().toISOString().split('T')[0]}.xlsx`
        XLSX.writeFile(workbook, downloadFileName)
        
    } catch (error) {
      ResultAlertDiv.innerHTML = `<div class="alert alert-error">ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜: ${error.message}</div>`;
    }
}

    </script>
  </body>
</html>
