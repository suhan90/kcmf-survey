<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KCMF ê°•ì˜í‰ê°€ ì„¤ë¬¸ì¡°ì‚¬</title>
    <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #4f46e5, #7c3aed);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }
        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            color: #64748b;
        }
        .nav-tab.active {
            background: white;
            color: #4f46e5;
            border-bottom: 3px solid #4f46e5;
            font-weight: bold;
        }
        .nav-tab:hover {
            background: #e2e8f0;
        }

        .content {
            padding: 30px;
            min-height: 400px;
        }

        .page {
            display: none;
        }
        .page.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #374151;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .rating-group {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
        }
        .rating-options {
            display: flex;
            gap: 10px;
        }
        .rating-options label {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: background 0.3s ease;
        }
        .rating-options label:hover {
            background: #e2e8f0;
        }
        .rating-options input[type="radio"] {
            margin-bottom: 5px;
        }
        
        .btn {
            background: linear-gradient(45deg, #4f46e5, #7c3aed);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 70, 229, 0.3);
        }
        .btn-secondary {
            background: #6b7280;
        }

        .survey-progress {
            background: #e5e7eb;
            height: 6px;
            border-radius: 3px;
            margin-bottom: 30px;
            overflow: hidden;
        }
        .survey-progress-bar {
            height: 100%;
            background: linear-gradient(45deg, #4f46e5, #7c3aed);
            transition: width 0.3s ease;
        }
        .survey-step {
            display: none;
        }
        .survey-step.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        .step-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }

        .intro-section {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .intro-section h3 {
            color: #4f46e5;
            margin-bottom: 15px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .alert-success { background: #d1fae5; color: #065f46; }
        .alert-error { background: #fee2e2; color: #991b1b; }
        .alert-info { background: #dbeafe; color: #1e40af; }

        .age-notice {
            display: none;
            padding: 10px;
            margin-top: 15px;
            background: #dbeafe;
            color: #1e40af;
            border-radius: 8px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ KCMF ê°•ì˜í‰ê°€ ì„¤ë¬¸ì¡°ì‚¬</h1>
            <p>êµìœ¡ ë§Œì¡±ë„ ì¡°ì‚¬ í”Œë«í¼</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showPage('intro')">ğŸ”§ ì•ˆë‚´</button>
            <button class="nav-tab" onclick="showPage('survey')">ğŸ“ ì„¤ë¬¸ ì‘ë‹µ</button>
        </div>

        <div class="content">
            <div id="intro" class="page active">

                <div id="qrcodeSection" style="margin-top: 20px;">
                    <h3>ğŸ“± í˜„ì¬ í˜ì´ì§€ QRì½”ë“œ</h3>
                    <br />
                    <canvas id="qrcodeCanvas"></canvas>
                </div>

                <div class="intro-section">
                    <h3>ì„¤ë¬¸ì„ ì‹œì‘í•˜ë ¤ë©´ ì•„ë˜ ë°©ë²• ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.</h3>
                    <p>1. ê´€ë¦¬ìì—ê²Œ ë°›ì€ ì„¤ë¬¸ URLë¡œ ì ‘ì† (URLì— í¬í•¨ëœ ê³ ìœ í‚¤ê°€ ìë™ ì¸ì‹ë©ë‹ˆë‹¤.)</p>
                    <p>2. ê³ ìœ í‚¤ê°€ ì—†ì–´ì„œ ì„¤ë¬¸ì´ ë‚˜íƒ€ë‚˜ì§€ ì•ŠëŠ” ê²½ìš°, ì•„ë˜ì— ê³ ìœ í‚¤ë¥¼ ì…ë ¥ í›„ 'ì„¤ë¬¸ ì‹œì‘' ë²„íŠ¼ì„ í´ë¦­</p>
                    <p>3. ìƒë‹¨ì˜ ì„¤ë¬¸ì‘ë‹µ íƒ­ì„ ëˆŒëŸ¬ ì„¤ë¬¸ë‚´ìš©ì„ ë³´ê³  ë‹µë³€</p>
                </div>

                <div id="manualSurveyEntry">
                    <div class="form-group">
                        <label for="surveyKey">ì„¤ë¬¸ URL ë˜ëŠ” ê³ ìœ í‚¤ ì…ë ¥:</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="surveyKey" placeholder="123456 ë˜ëŠ” ì „ì²´ URL">
                            <button class="btn" onclick="loadSurveyFromInput()">ì„¤ë¬¸ ì‹œì‘</button>
                        </div>
                    </div>
                </div>


                <div id="connectionStatus"></div>
                 <button class="btn btn-secondary" onclick="testConnection()">DB ì—°ê²° í…ŒìŠ¤íŠ¸</button>
            </div>

            <div id="survey" class="page">
                <div id="surveyContent" style="display: none;">

                    <div id="surveyInfo" class="alert alert-info" style="display: none;">
                        <h3><strong>ê°•ì‚¬:</strong> <span id="displayInstructor"></span></h3>
                        <h3><strong>êµìœ¡ëª…:</strong> <span id="displayEducation"></span></h3>
                        <h3><strong>ì„¼í„°:</strong> <span id="displayCenter"></span></h3>
                    </div>

                    <div class="survey-progress">
                        <div class="survey-progress-bar" id="progressBar" style="width: 25%"></div>
                    </div>

                    <div id="step1" class="survey-step active">
                        <h3>1ë‹¨ê³„: ê¸°ë³¸ ì •ë³´</h3>
                        <div class="form-group">
                            <label>ì„±ëª…:</label>
                            <input type="text" id="respondentName">
                        </div>
                        <div class="form-group">
                            <label>ì„±ë³„:</label>
                            <div class="rating-options">
                                <label><input type="radio" name="gender" value="ë‚¨ì„±">ë‚¨ì„±</label>
                                <label><input type="radio" name="gender" value="ì—¬ì„±">ì—¬ì„±</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>ì—°ë ¹ëŒ€:</label>
                            <div class="rating-options">
                                <label><input type="radio" name="ageGroup" value="10ëŒ€ë¯¸ë§Œ">10ëŒ€ë¯¸ë§Œ</label>
                                <label><input type="radio" name="ageGroup"  value="10ëŒ€">10ëŒ€</label>
                                <label><input type="radio" name="ageGroup"  value="20ëŒ€">20ëŒ€</label>
                                <label><input type="radio" name="ageGroup"  value="30ëŒ€">30ëŒ€</label>
                                <label><input type="radio" name="ageGroup"  value="40ëŒ€">40ëŒ€</label>
                                <label><input type="radio" name="ageGroup"  value="50ëŒ€">50ëŒ€</label>
                                <label><input type="radio" name="ageGroup"  value="60ëŒ€ ì´ìƒ">60ëŒ€ ì´ìƒ</label>
                            </div>
                        </div>
                        <div id="ageNotice" class="age-notice">
                            ì—°ë ¹ëŒ€ì— ë”°ë¼ ì„¤ë¬¸ ë¬¸í•­ì´ ìë™ìœ¼ë¡œ ì¡°ì •ë©ë‹ˆë‹¤.
                        </div>
                    </div>

                    <div id="step2" class="survey-step">
                        <h3>2ë‹¨ê³„: êµìœ¡ë‚´ìš© ë° ìš´ì˜ í‰ê°€</h3>
                        <div id="questions-group-1"></div>
                    </div>

                    <div id="step3" class="survey-step">
                        <h3>3ë‹¨ê³„: ê°•ì‚¬ í‰ê°€</h3>
                        <div id="questions-group-2"></div>
                    </div>

                    <div id="step4" class="survey-step">
                        <h3>4ë‹¨ê³„: ì´ê´„ í‰ê°€</h3>
                        <div id="questions-group-3"></div>
                        <div class="form-group">
                            <label>ê¸°íƒ€ ì˜ê²¬:</label>
                            <p>â€» ì‹œì²­ìë¯¸ë””ì–´ì¬ë‹¨ì˜ êµìœ¡ì— ëŒ€í•˜ì—¬ í•˜ê³  ì‹¶ì€ ë§ì„ ì ì–´ì£¼ì‹­ì‹œì˜¤(ì˜ˆ : ê°œì„ ì , ë°”ë¼ëŠ”ì , ê³ ë§ˆìš´ì  ë“±).</p>
                            <textarea id="additionalComments" rows="4" placeholder="ììœ ë¡­ê²Œ ì˜ê²¬ì„ ì‘ì„±í•´ì£¼ì„¸ìš”."></textarea>
                        </div>
                    </div>

                    <div id="surveyAlertStatus"></div>

                    <div class="step-navigation">
                        <button class="btn btn-secondary" id="prevBtn" onclick="prevStep()" style="display: none;">ì´ì „</button>
                        <button class="btn" id="nextBtn" onclick="nextStep()">ë‹¤ìŒ</button>
                        <button class="btn" id="submitBtn" onclick="submitSurvey()" style="display: none;">ì„¤ë¬¸ ì œì¶œ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // ì„¤ë¬¸íŒŒì¼ ìœ„ì¹˜ (QR ì½”ë“œ ìƒì„±ì—ë„ ì‚¬ìš©)
    // var survey_url = 'https://kcmf.or.kr/survey.html';
    var survey_url = window.location.href; 
    // DB ì ‘ì† ë° ìƒì„±
	var supabase = supabase.createClient('https://fnxmyayfosjwuvsxbabm.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZueG15YXlmb3Nqd3V2c3hiYWJtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk2MTg2NzcsImV4cCI6MjA2NTE5NDY3N30.rAldXcD4_tsstfd9xHzKw3QgIHBrHvaFkBv6TJRVhjA')
	
    let currentStep = 1;
    let currentSurveyInfo = null;

    // [ìˆ˜ì •] ì—°ë ¹ëŒ€ë³„ ì„¤ë¬¸ ë¬¸í•­ ì •ì˜
    const surveyQuestions = {
        '10ëŒ€ë¯¸ë§Œ': [
            "ë‚˜ëŠ” ì„ ìƒë‹˜ì˜ ìˆ˜ì—…ì„ ë“£ëŠ” ê²ƒì´ ì¦ê²ìŠµë‹ˆë‹¤.",
            "ë‚˜ëŠ” ì„ ìƒë‹˜ì˜ ë§ì”€ì´ ì™ì™ ì´í•´ë©ë‹ˆë‹¤.",
            "ë‚˜ì—ê²Œ ìˆ˜ì—… ì‹œê°„ì€ ë”± ì•Œë§ìŠµë‹ˆë‹¤.",
            "ë‚˜ëŠ” ìˆ˜ì—… ì‹œê°„ì— ë‚˜ëˆ ì£¼ì‹  í™œë™ì§€(êµì¬)ê°€ ì¢‹ì•˜ìŠµë‹ˆë‹¤.",
            "ì„ ìƒë‹˜ì€ ìˆ˜ì—…ë‚´ìš©ì„ ì˜ ì•Œê³  ê³„ì‹­ë‹ˆë‹¤.",
            "ì„ ìƒë‹˜ì€ ìˆ˜ì—…ì„ ì—´ì‹¬íˆ í•˜ì‹­ë‹ˆë‹¤.",
            "ì„ ìƒë‹˜ì˜ ë§ì”€ì€ ì§‘ì¤‘ì´ ì˜ë©ë‹ˆë‹¤.",
            "ì„ ìƒë‹˜ì€ ë‚˜ì™€ ì¹œêµ¬ë“¤ì˜ ì´ì•¼ê¸°ë¥¼ ì˜ ë“¤ì–´ì£¼ì‹­ë‹ˆë‹¤.",
            "ì„ ìƒë‹˜ì˜ ìˆ˜ì—…ì€ ë‚˜ì—ê²Œ ë„ì›€ì´ ë©ë‹ˆë‹¤.",
            "ì„ ìƒë‹˜ì˜ ìˆ˜ì—…ì€ ëŠ˜ ê¸°ë‹¤ë ¤ì§‘ë‹ˆë‹¤."
        ],
        '10ëŒ€': [
            "ìˆ˜ì—… ë‚´ìš©ì´ ì¢‹ì•˜ë‚˜ìš”?",
            "ìˆ˜ì—… ë‚´ìš©ì´ ë„ˆë¬´ ì–´ë µê±°ë‚˜ ì‰½ì§€ëŠ” ì•Šì•˜ë‚˜ìš”?",
            "ìˆ˜ì—… ì‹œê°„ì€ ì ë‹¹í–ˆë‚˜ìš”?",
            "ìˆ˜ì—… ì‹œê°„ì— ë‚˜ëˆ„ì–´ì¤€ ìë£Œë“¤ì€ ì ì ˆí–ˆë‚˜ìš”?",
            "ì„ ìƒë‹˜ì€ ìˆ˜ì—…ë‚´ìš©ì„ ì˜ ì•Œê³  ê³„ì‹œë‚˜ìš”?",
            "ì„ ìƒë‹˜ì€ ìˆ˜ì—…ì„ ì—´ì‹¬íˆ í•˜ì…¨ë‚˜ìš”?",
            "ì„ ìƒë‹˜ì€ ìˆ˜ì—… ë‚´ìš©ì„ ì´í•´í•˜ê¸° ì‰½ê²Œ ì˜ ì„¤ëª…í•´ ì£¼ì…¨ë‚˜ìš”?",
            "ì„ ìƒë‹˜ì€ í•™ìƒë“¤ê³¼ ì†Œí†µí•˜ê¸° ìœ„í•´ ë…¸ë ¥í•˜ì…¨ë‚˜ìš”?",
            "ì´ ìˆ˜ì—…ì´ ë‚˜ì—ê²Œ ë„ì›€ì´ ë˜ì—ˆë‚˜ìš”?",
            "ì´ ìˆ˜ì—…ì´ ì „ë°˜ì ìœ¼ë¡œ ë§Œì¡±ìŠ¤ëŸ½ë‚˜ìš”?"
        ],
        'default': [
            "ê·€í•˜ëŠ” êµìœ¡ ë‚´ìš©ì— ë§Œì¡±í•˜ì‹­ë‹ˆê¹Œ?",
            "ê·€í•˜ëŠ” êµìœ¡ ìˆ˜ì¤€(ë‚œì´ë„)ì— ë§Œì¡±í•˜ì‹­ë‹ˆê¹Œ?",
            "ê·€í•˜ëŠ” êµìœ¡ íšŸìˆ˜ì— ë§Œì¡±í•˜ì‹­ë‹ˆê¹Œ?",
            "ê·€í•˜ëŠ” êµìœ¡ìë£Œ ë˜ëŠ” êµì¬ì— ëŒ€í•´ ë§Œì¡±í•˜ì‹­ë‹ˆê¹Œ?",
            "ê·€í•˜ëŠ” ê°•ì‚¬ì˜ ì „ë¬¸ì„±ì— ëŒ€í•´ ë§Œì¡±í•˜ì‹­ë‹ˆê¹Œ?",
            "ê·€í•˜ëŠ” ê°•ì‚¬ì˜ ì„±ì‹¤ì„± ë° ì¤€ë¹„ì„±ì— ëŒ€í•´ ë§Œì¡±í•˜ì‹­ë‹ˆê¹Œ?",
            "ê·€í•˜ëŠ” ê°•ì‚¬ì˜ ìˆ˜ì—…ì§€ë„ë ¥ ë° ì „ë‹¬ë ¥ì— ëŒ€í•´ ë§Œì¡±í•˜ì‹­ë‹ˆê¹Œ?",
            "ê·€í•˜ëŠ” ê°•ì‚¬ì˜ ìˆ˜ê°•ìƒê³¼ì˜ ì†Œí†µë…¸ë ¥ì— ë§Œì¡±í•˜ì‹­ë‹ˆê¹Œ?",
            "ê·€í•˜ëŠ” ì´ êµìœ¡ì´ ë³¸ì¸ì—ê²Œ ë„ì›€ì´ ë˜ì—ˆë‹¤ê³  ìƒê°í•˜ì‹­ë‹ˆê¹Œ?",
            "ê·€í•˜ëŠ” í•´ë‹¹ êµìœ¡ì— ì „ë°˜ì ìœ¼ë¡œ ë§Œì¡±í•˜ì‹­ë‹ˆê¹Œ?"
        ]
    };

    // [ìˆ˜ì •] ì—°ë ¹ëŒ€ë³„ í‰ê°€ ì˜µì…˜ ì •ì˜
    const ratingOptions = {
        '10ëŒ€ë¯¸ë§Œ': [
            {value: 1, text: "ì „í˜€<br>ê·¸ë ‡ì§€ì•Šë‹¤"},
            {value: 2, text: "ê·¸ë ‡ì§€ì•Šë‹¤"},
            {value: 3, text: "ë³´í†µì´ë‹¤"},
            {value: 4, text: "ê·¸ë ‡ë‹¤"},
            {value: 5, text: "ë§¤ìš°<br>ê·¸ë ‡ë‹¤"}
        ],
        '10ëŒ€': [
            {value: 1, text: "ì „í˜€<br>ê·¸ë ‡ì§€ì•Šë‹¤"},
            {value: 2, text: "ê·¸ë ‡ì§€ì•Šë‹¤"},
            {value: 3, text: "ë³´í†µì´ë‹¤"},
            {value: 4, text: "ê·¸ë ‡ë‹¤"},
            {value: 5, text: "ë§¤ìš°<br>ê·¸ë ‡ë‹¤"}
        ],
        'default': [
            {value: 1, text: "ë§¤ìš°<br>ë¶ˆë§Œì¡±"},
            {value: 2, text: "ë¶ˆë§Œì¡±"},
            {value: 3, text: "ë³´í†µ"},
            {value: 4, text: "ë§Œì¡±"},
            {value: 5, text: "ë§¤ìš°<br>ë§Œì¡±"}
        ]
    };

    // [ì¶”ê°€] ì—°ë ¹ëŒ€ ì„ íƒ ì‹œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    document.querySelectorAll('input[name="ageGroup"]').forEach(radio => {
        radio.addEventListener('change', () => {
            document.getElementById('ageNotice').style.display = 'block';
        });
    });

    // [ìˆ˜ì •] ì—°ë ¹ëŒ€ì— ë”°ë¥¸ ì„¤ë¬¸ ë¬¸í•­ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateSurveyQuestions() {
        const selectedAge = document.querySelector('input[name="ageGroup"]:checked');
        if (!selectedAge) return;
        
        const ageGroup = selectedAge.value;
        let questionsToUse = surveyQuestions.default;
        let optionsToUse = ratingOptions.default;
        
        if (ageGroup === '10ëŒ€ë¯¸ë§Œ') {
            questionsToUse = surveyQuestions['10ëŒ€ë¯¸ë§Œ'];
            optionsToUse = ratingOptions['10ëŒ€ë¯¸ë§Œ'];
        } else if (ageGroup === '10ëŒ€') {
            questionsToUse = surveyQuestions['10ëŒ€'];
            optionsToUse = ratingOptions['10ëŒ€'];
        }
        
        // ë¬¸í•­ ê·¸ë£¹ë³„ë¡œ ë‚˜ëˆ„ì–´ ìƒì„±
        generateQuestionGroup('questions-group-1', questionsToUse.slice(0, 4), optionsToUse, 1);
        generateQuestionGroup('questions-group-2', questionsToUse.slice(4, 8), optionsToUse, 5);
        generateQuestionGroup('questions-group-3', questionsToUse.slice(8, 10), optionsToUse, 9);
    }

    // [ìˆ˜ì •] ì§ˆë¬¸ ê·¸ë£¹ ìƒì„± í•¨ìˆ˜
    function generateQuestionGroup(containerId, questions, options, startIndex) {
        const container = document.getElementById(containerId);
        container.innerHTML = ''; // ì´ì „ ë¬¸í•­ ì´ˆê¸°í™”
        
        questions.forEach((question, index) => {
            const questionNum = startIndex + index;
            const questionDiv = document.createElement('div');
            questionDiv.className = 'rating-group';
            
            const optionsHtml = options.map(option => 
                `<label><input type="radio" name="q${questionNum}" value="${option.value}"><small>${option.text}</small></label>`
            ).join('');
            
            questionDiv.innerHTML = `
                <div>${questionNum}. ${question}</div>
                <div class="rating-options">
                    ${optionsHtml}
                </div>
            `;
            
            container.appendChild(questionDiv);
        });
    }


    // Supabase ì—°ê²° í…ŒìŠ¤íŠ¸
    async function testConnection() {
        try {
            const { data, error } = await supabase.from('education_info').select('count').limit(1);
            if (error) throw error;
            showAlert('ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í…ŒìŠ¤íŠ¸ ì„±ê³µ!', 'success', 'connectionStatus');
        } catch (error) {
            showAlert('ë°ì´í„°ë² ì´ìŠ¤ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ' + error.message, 'error', 'connectionStatus');
        }
    }

    // ì•Œë¦¼ í‘œì‹œ
    function showAlert(message, type, elementId) {
        const statusDiv = document.getElementById(elementId);
        if (statusDiv) {
            statusDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 5000);
        }
    }

    // í˜ì´ì§€(íƒ­) ì „í™˜
    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
        document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
        
        document.getElementById(pageId).classList.add('active');
        document.querySelector(`.nav-tab[onclick="showPage('${pageId}')"]`).classList.add('active');
    }

    // ì…ë ¥ì°½ì˜ ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜
    function loadSurveyFromInput() {
        const key = document.getElementById('surveyKey').value;
        drawQRCode(key);
        loadSurveyInfo(key);
    }

    // ê³ ìœ í‚¤ë¡œ ì„¤ë¬¸ ì •ë³´ë¥¼ ë¡œë“œí•˜ëŠ” í•µì‹¬ í•¨ìˆ˜
    async function loadSurveyInfo(uniqueKeyInput) {
        if (!supabase) {
            showAlert('Supabaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'error', 'connectionStatus');
            return;
        }

        let uniqueKey = uniqueKeyInput;
        if (!uniqueKey) {
            showAlert('ì„¤ë¬¸ URL ë˜ëŠ” ê³ ìœ í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error', 'connectionStatus');
            return;
        }
        
        if (uniqueKey.includes('#s=')) {
            uniqueKey = uniqueKey.split('#s=')[1];
        } else if (uniqueKey.includes('s=')) {
            uniqueKey = uniqueKey.split('s=')[1];
        }

        showAlert('ì„¤ë¬¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...', 'info', 'connectionStatus');

        try {
            const { data, error } = await supabase
                .from('education_info')
                .select('*')
                .eq('unique_key', uniqueKey)
                .single();

            if (error || !data) {
                throw new Error('í•´ë‹¹ ê³ ìœ í‚¤ì˜ ì„¤ë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }

            // [ì¶”ê°€] ì„¤ë¬¸ ê¸°ê°„ ìœ íš¨ì„± ê²€ì‚¬
            if (!data.start_date || !data.end_date) {
                throw new Error('ì„¤ë¬¸ ê¸°ê°„ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
            }
            const startDate = new Date(data.start_date);
            const endDate = new Date(data.end_date);
            const currentDate = new Date();
            // ì‹œê°„ì„ 0ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ ë‚ ì§œë§Œ ë¹„êµ (ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ ë‹¹ì¼ í¬í•¨)
            startDate.setHours(0, 0, 0, 0);
            endDate.setHours(0, 0, 0, 0);
            currentDate.setHours(0, 0, 0, 0);

            if (currentDate >= startDate && currentDate <= endDate) {
                // í‰ê°€ ê¸°ê°„ì´ ìœ íš¨í•œ ê²½ìš°, ê¸°ì¡´ ë¡œì§ ìˆ˜í–‰
                currentSurveyInfo = data;
                document.getElementById('displayInstructor').textContent = data.instructor_name;
                document.getElementById('displayEducation').textContent = data.education_name;
                document.getElementById('displayCenter').textContent = data.center_name;
                document.getElementById('surveyInfo').style.display = 'block';
                document.getElementById('surveyContent').style.display = 'block';
                
                showPage('survey');
                
                currentStep = 1;
                showStep(1);

                const statusDiv = document.getElementById('connectionStatus');
                if (statusDiv) statusDiv.innerHTML = '';
            
            } else {
                // í‰ê°€ ê¸°ê°„ì´ ì•„ë‹Œ ê²½ìš°, ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
                throw new Error('í•´ë‹¹ ê°•ì¢Œì˜ í‰ê°€ê¸°ê°„ì´ ì•„ë‹™ë‹ˆë‹¤.');                
            }
        } catch (error) {
            showAlert('ì„¤ë¬¸ ì •ë³´ ë¡œë”© ì‹¤íŒ¨: ' + error.message, 'error', 'connectionStatus');
            document.getElementById('surveyContent').style.display = 'none'; // ì„¤ë¬¸ ë‚´ìš© ìˆ¨ê¹€
        }
    }

    // ì„¤ë¬¸ ë‹¨ê³„ í‘œì‹œ
    function showStep(step) {
        document.querySelectorAll('.survey-step').forEach(s => s.classList.remove('active'));
        document.getElementById(`step${step}`).classList.add('active');
        
        const progress = (step / 4) * 100;
        document.getElementById('progressBar').style.width = progress + '%';
        
        document.getElementById('prevBtn').style.display = step > 1 ? 'inline-block' : 'none';
        document.getElementById('nextBtn').style.display = step < 4 ? 'inline-block' : 'none';
        document.getElementById('submitBtn').style.display = step === 4 ? 'inline-block' : 'none';
        
        currentStep = step;
    }

    // ë‹¤ìŒ ë‹¨ê³„
    function nextStep() {
        if (validateCurrentStep()) {
            if (currentStep === 1) {
                updateSurveyQuestions(); // 1ë‹¨ê³„ ì™„ë£Œ í›„ ì§ˆë¬¸ ì—…ë°ì´íŠ¸
            }
            showStep(currentStep + 1);
        }
    }

    // ì´ì „ ë‹¨ê³„
    function prevStep() {
        showStep(currentStep - 1);
    }

    // í˜„ì¬ ë‹¨ê³„ ìœ íš¨ì„± ê²€ì‚¬
    function validateCurrentStep() {
        const surveyAlertElementId = 'surveyAlertStatus';
        switch(currentStep) {
            case 1:
                if (!document.getElementById('respondentName').value) {
                    showAlert('ì„±ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error', surveyAlertElementId); return false;
                }
                if (!document.querySelector('input[name="gender"]:checked')) {
                    showAlert('ì„±ë³„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error', surveyAlertElementId); return false;
                }
                if (!document.querySelector('input[name="ageGroup"]:checked')) {
                    showAlert('ì—°ë ¹ëŒ€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error', surveyAlertElementId); return false;
                }
                return true;
                
            case 2:
                for (let i = 1; i <= 4; i++) {
                    if (!document.querySelector(`input[name="q${i}"]:checked`)) {
                        showAlert(`${i}ë²ˆ ë¬¸í•­ì„ í‰ê°€í•´ì£¼ì„¸ìš”.`, 'error', surveyAlertElementId); return false;
                    }
                }
                return true;
                
            case 3:
                for (let i = 5; i <= 8; i++) {
                    if (!document.querySelector(`input[name="q${i}"]:checked`)) {
                        showAlert(`${i}ë²ˆ ë¬¸í•­ì„ í‰ê°€í•´ì£¼ì„¸ìš”.`, 'error', surveyAlertElementId); return false;
                    }
                }
                return true;
                
            case 4:
                 for (let i = 9; i <= 10; i++) {
                    if (!document.querySelector(`input[name="q${i}"]:checked`)) {
                        showAlert(`${i}ë²ˆ ë¬¸í•­ì„ í‰ê°€í•´ì£¼ì„¸ìš”.`, 'error', surveyAlertElementId); return false;
                    }
                }
                return true;
            default:
                return true;
        }
    }

    // ì„¤ë¬¸ ì œì¶œ
    async function submitSurvey() {
        if (!validateCurrentStep()) return;
        if (!supabase || !currentSurveyInfo) {
            showAlert('ì„¤ë¬¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error', 'surveyContent');
            return;
        }

        const surveyData = {
            unique_key: currentSurveyInfo.unique_key,
            center_name: currentSurveyInfo.center_name,
            instructor_name: currentSurveyInfo.instructor_name,
            education_name: currentSurveyInfo.education_name,
            respondent_name: document.getElementById('respondentName').value,
            gender: document.querySelector('input[name="gender"]:checked').value,
            age_group: document.querySelector('input[name="ageGroup"]:checked').value,
            q1_rating: parseInt(document.querySelector('input[name="q1"]:checked').value),
            q2_rating: parseInt(document.querySelector('input[name="q2"]:checked').value),
            q3_rating: parseInt(document.querySelector('input[name="q3"]:checked').value),
            q4_rating: parseInt(document.querySelector('input[name="q4"]:checked').value),
            q5_rating: parseInt(document.querySelector('input[name="q5"]:checked').value),
            q6_rating: parseInt(document.querySelector('input[name="q6"]:checked').value),
            q7_rating: parseInt(document.querySelector('input[name="q7"]:checked').value),
            q8_rating: parseInt(document.querySelector('input[name="q8"]:checked').value),
            q9_rating: parseInt(document.querySelector('input[name="q9"]:checked').value),
            q10_rating: parseInt(document.querySelector('input[name="q10"]:checked').value),
            additional_comments: document.getElementById('additionalComments').value
        };

        try {
            const { error } = await supabase.from('survey_results').insert([surveyData]);

            if (error) throw error;
            
            showPage('intro');
            showAlert('ì„¤ë¬¸ì´ ì„±ê³µì ìœ¼ë¡œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤! ì°¸ì—¬í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.', 'success', 'connectionStatus');
            
            document.getElementById('surveyContent').style.display = 'none';
            document.getElementById('surveyKey').value = '';
            currentSurveyInfo = null;
            
        } catch (error) {
            showAlert('ì œì¶œ ì‹¤íŒ¨: ' + error.message, 'error', 'surveyContent');
        }
    }

    // QRì½”ë“œ ìƒì„±
    function drawQRCode(surveyKey) {
        if (!surveyKey) return;
        const qr = new QRious({
            element: document.getElementById('qrcodeCanvas'),
            value: survey_url + '#s=' + surveyKey,
            size: 200,
            level: 'H'
        });
    }

    window.addEventListener('load', function() {
        const hash = window.location.hash;
        if (hash.includes('#s=')) {
            const surveyKey = hash.split('s=')[1];
            if (surveyKey) {
                document.getElementById('manualSurveyEntry').style.display = 'none';
                drawQRCode(surveyKey);
                loadSurveyInfo(surveyKey);
            }
        }
    });

    </script>
</body>
</html>